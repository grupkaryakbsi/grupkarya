<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grup Karya</title>
<link rel="icon" type="image/png" href="https://i.imgur.com/wz811e4.png">
<link rel="apple-touch-icon" href="https://i.imgur.com/wz811e4.png">
    <meta property="og:title" content="Grup Karya">
    <meta property="og:description" content="Platform Kolaborasi Mahasiswa">
    <meta property="og:image" content="https://i.imgur.com/wz811e4.png">
    <meta property="og:url" content="https://USERNAME.github.io/REPO-NAME/">
    <meta name="theme-color" content="#7B2D8B">
    <title>Grup Karya - Platform Kolaborasi Mahasiswa</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root{
            --primary:#7B2D8B;--secondary:#f3e8f7;--dark:#2d1b35;--light:#fff;
            --success:#28a745;--warning:#ffc107;--danger:#dc3545;--gray:#6c757d;
            --purple:#9c27b0;--orange:#ff9800;--gold:#ffd700;
            --bg-main:#faf8fc;--bg-card:#fff;--text-primary:#2d1b35;
            --text-secondary:#7B6B8B;--border-color:#e8dff0;--shadow:rgba(123,45,139,.1);
        }
        [data-theme="dark"]{
            --primary:#b06acc;--secondary:#2d1b3d;--dark:#e9ecef;--light:#1a1a2e;
            --bg-main:#0f0a15;--bg-card:#1a1028;--text-primary:#e9ecef;
            --text-secondary:#a0899b;--border-color:#3d2d4d;--shadow:rgba(123,45,139,.3);
        }
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        @keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
        @keyframes fadeInUp{from{opacity:0;transform:translateY(22px)}to{opacity:1;transform:translateY(0)}}
        @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
        @keyframes gradShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
        @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(232,57,90,.35)}50%{box-shadow:0 0 0 10px rgba(232,57,90,0)}}

        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Nunito',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg-main);color:var(--text-primary);line-height:1.6;transition:background .3s,color .3s}

        .loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(45,27,61,.88);display:none;justify-content:center;align-items:center;z-index:9999;flex-direction:column;backdrop-filter:blur(4px)}
        .spinner{border:5px solid rgba(255,255,255,.2);border-top:5px solid #E8395A;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite}
        .loading-text{color:#fff;margin-top:20px;font-size:1.1rem;font-weight:700}

        nav{
            background:linear-gradient(135deg,#7B2D8B 0%,#4A1860 50%,#E8395A 100%);
            background-size:200% 200%;animation:gradShift 7s ease infinite;
            padding:1rem 5%;display:flex;justify-content:space-between;align-items:center;
            box-shadow:0 4px 20px rgba(123,45,139,.35);position:sticky;top:0;z-index:1000;
        }
        .logo{font-size:1.8rem;font-weight:900;color:#fff;cursor:pointer;display:flex;align-items:center;gap:10px}
        .logo-img{height:48px;object-fit:contain;filter:drop-shadow(0 2px 8px rgba(0,0,0,.25));transition:transform .3s}
        .logo-img:hover{transform:scale(1.07)}
        .nav-links{display:flex;align-items:center;gap:25px}
        .nav-links a{color:#fff;text-decoration:none;font-weight:700;cursor:pointer;padding:8px 16px;border-radius:20px;transition:.3s}
        .nav-links a:hover{background:rgba(255,255,255,.2);transform:translateY(-1px)}
        .btn-nav{background:#fff;color:var(--primary);padding:10px 24px;border-radius:25px;border:none;font-weight:800;cursor:pointer;transition:.3s;font-family:'Nunito',sans-serif}
        .btn-nav:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,.2)}
        .user-pill{background:rgba(255,255,255,.22);padding:10px 20px;border-radius:30px;color:#fff;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:10px;border:2px solid rgba(255,255,255,.25);transition:.3s}
        .user-pill:hover{background:rgba(255,255,255,.32)}
        .admin-pill{background:linear-gradient(135deg,#dc3545,#c82333)!important;border:2px solid rgba(255,255,255,.5)!important}
        .theme-toggle{background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.25);color:#fff;width:40px;height:40px;border-radius:50%;cursor:pointer;font-size:1.2rem;transition:.3s;display:flex;align-items:center;justify-content:center}
        .theme-toggle:hover{background:rgba(255,255,255,.35);transform:rotate(15deg) scale(1.1)}
        /* Tombol pencarian nav */
        .btn-search-nav{background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.25);color:#fff;width:40px;height:40px;border-radius:50%;cursor:pointer;font-size:1.1rem;transition:.3s;display:flex;align-items:center;justify-content:center}
        .btn-search-nav:hover{background:rgba(255,255,255,.35);transform:scale(1.1)}

        /* ===== GAME BUTTON & LIST ===== */
        .btn-game-nav{background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.25);color:#fff;padding:8px 16px;border-radius:20px;cursor:pointer;font-size:.9rem;font-weight:700;transition:.3s;font-family:'Nunito',sans-serif;display:flex;align-items:center;gap:6px}
        .btn-game-nav:hover{background:rgba(255,255,255,.35);transform:translateY(-1px)}
        .game-list-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:20px;margin-top:20px}
        .game-card{background:var(--bg-main);border:2px solid var(--border-color);border-radius:18px;padding:25px 20px;text-align:center;cursor:pointer;transition:.3s;position:relative;overflow:hidden}
        .game-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(135deg,#7B2D8B,#E8395A)}
        .game-card:hover{border-color:var(--primary);transform:translateY(-5px);box-shadow:0 10px 30px var(--shadow)}
        .game-card-icon{font-size:3.5rem;margin-bottom:12px}
        .game-card-name{font-size:1.1rem;font-weight:800;color:var(--text-primary);margin-bottom:6px}
        .game-card-desc{font-size:.8rem;color:var(--text-secondary);line-height:1.5}
        .game-card-badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:.7rem;font-weight:700;background:linear-gradient(135deg,#7B2D8B,#E8395A);color:#fff;margin-top:8px}

        /* ===== WEREWOLF GAME STYLES ===== */
        .ww-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:#0a0a1a;z-index:3000;display:none;flex-direction:column;font-family:'Nunito',sans-serif}
        .ww-header{background:linear-gradient(135deg,#1a0030,#3d0060);padding:15px 25px;display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid rgba(123,45,139,.5)}
        .ww-title{color:#fff;font-weight:900;font-size:1.3rem;display:flex;align-items:center;gap:10px}
        .ww-phase-badge{padding:6px 18px;border-radius:20px;font-weight:700;font-size:.9rem}
        .phase-night{background:linear-gradient(135deg,#1a237e,#0d47a1);color:#90caf9}
        .phase-morning{background:linear-gradient(135deg,#f57f17,#ff8f00);color:#fff}
        .phase-day{background:linear-gradient(135deg,#2e7d32,#43a047);color:#fff}
        .phase-vote{background:linear-gradient(135deg,#b71c1c,#c62828);color:#fff}
        .ww-body{display:flex;flex:1;overflow:hidden;height:calc(100vh - 60px)}
        .ww-sidebar{width:220px;background:rgba(255,255,255,.04);border-right:1px solid rgba(255,255,255,.1);padding:15px;overflow-y:auto;flex-shrink:0}
        .ww-main{flex:1;display:flex;flex-direction:column;overflow:hidden}
        .ww-chat{flex:1;padding:15px;overflow-y:auto;display:flex;flex-direction:column;gap:8px}
        .ww-input-area{padding:12px 15px;border-top:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.03);display:flex;gap:10px}
        .ww-input{flex:1;padding:10px 16px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:25px;color:#fff;font-family:'Nunito',sans-serif;font-size:.95rem}
        .ww-input:focus{outline:none;border-color:#7B2D8B}
        .ww-input::placeholder{color:rgba(255,255,255,.35)}
        .ww-send-btn{padding:10px 20px;background:linear-gradient(135deg,#7B2D8B,#E8395A);color:#fff;border:none;border-radius:25px;cursor:pointer;font-weight:700;font-family:'Nunito',sans-serif}
        .ww-player-item{padding:10px;border-radius:10px;background:rgba(255,255,255,.05);margin-bottom:8px;color:#e0e0e0;font-size:.85rem}
        .ww-player-item.alive{border-left:3px solid #4caf50}
        .ww-player-item.dead{border-left:3px solid #f44336;opacity:.5;text-decoration:line-through}
        .ww-player-item.self{background:rgba(123,45,139,.2);border-left:3px solid #7B2D8B}
        .ww-msg{padding:10px 14px;border-radius:12px;max-width:80%;word-break:break-word;font-size:.9rem;line-height:1.5}
        .ww-msg.system{background:rgba(255,200,0,.1);border:1px solid rgba(255,200,0,.25);color:#ffd54f;align-self:center;text-align:center;max-width:95%;font-style:italic}
        .ww-msg.clue{background:rgba(123,45,139,.2);border:1px solid rgba(123,45,139,.4);color:#e1bee7;align-self:center;text-align:center;max-width:95%;border-radius:16px;padding:14px 20px}
        .ww-msg.own{background:linear-gradient(135deg,#7B2D8B,#4a1860);color:#fff;align-self:flex-end;border-radius:18px 18px 4px 18px}
        .ww-msg.other{background:rgba(255,255,255,.08);color:#e0e0e0;align-self:flex-start;border-radius:18px 18px 18px 4px}
        .ww-msg.dead-announce{background:rgba(244,67,54,.12);border:1px solid rgba(244,67,54,.35);color:#ef9a9a;align-self:center;max-width:95%;text-align:center}
        .ww-msg.propaganda{background:rgba(255,152,0,.1);border:1px dashed rgba(255,152,0,.4);color:#ffcc80;align-self:center;max-width:95%;font-style:italic}
        .ww-msg .msg-sender{font-size:.7rem;font-weight:700;margin-bottom:4px;opacity:.7}
        .ww-msg .msg-time{font-size:.65rem;opacity:.5;margin-top:3px;text-align:right}
        .ww-action-panel{padding:12px 15px;border-top:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.03)}
        .ww-action-btn{padding:8px 16px;border:none;border-radius:20px;cursor:pointer;font-weight:700;font-size:.85rem;margin:4px;font-family:'Nunito',sans-serif;transition:.2s}
        .ww-action-btn:hover{transform:translateY(-1px);filter:brightness(1.15)}
        .ww-action-btn.night-action{background:linear-gradient(135deg,#1a237e,#283593);color:#90caf9}
        .ww-action-btn.day-action{background:linear-gradient(135deg,#4a148c,#6a1b9a);color:#e1bee7}
        .ww-action-btn.vote-action{background:linear-gradient(135deg,#b71c1c,#c62828);color:#fff}
        .ww-action-btn.prop-action{background:linear-gradient(135deg,#e65100,#bf360c);color:#fff}
        .ww-role-card{background:linear-gradient(135deg,rgba(123,45,139,.3),rgba(232,57,90,.15));border:2px solid rgba(123,45,139,.5);border-radius:14px;padding:15px;margin-bottom:15px;color:#fff}
        .ww-role-name{font-size:1rem;font-weight:900;margin-bottom:4px}
        .ww-role-desc{font-size:.75rem;opacity:.75;line-height:1.4}
        .ww-timer{background:rgba(255,255,255,.08);border-radius:10px;padding:8px 12px;margin-bottom:10px;text-align:center;color:#fff;font-weight:700;font-size:.9rem}
        .ww-score-card{background:rgba(255,255,255,.05);border-radius:10px;padding:10px;margin-bottom:8px;color:#e0e0e0;font-size:.8rem}
        .ww-lobby{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:30px;text-align:center;color:#fff}
        .ww-lobby h2{font-size:2rem;font-weight:900;margin-bottom:15px;background:linear-gradient(135deg,#E8395A,#7B2D8B);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .ww-room-code{font-size:3rem;font-weight:900;letter-spacing:8px;color:#E8395A;background:rgba(232,57,90,.1);border:2px solid rgba(232,57,90,.3);border-radius:16px;padding:15px 30px;margin:20px 0}
        .ww-player-lobby-list{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:15px 0;max-width:500px}
        .ww-lobby-player{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:8px 16px;color:#e0e0e0;font-size:.9rem}
        .ww-lobby-player.host{border-color:#E8395A;color:#ff8a80}
        .ww-result-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.9);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10;color:#fff;text-align:center;padding:30px}
        .ww-result-title{font-size:2.5rem;font-weight:900;margin-bottom:20px}
        .ww-result-win{color:#4caf50}
        .ww-result-lose{color:#f44336}
        .ww-prop-input{width:100%;padding:8px 14px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);border-radius:10px;color:#fff;font-family:'Nunito',sans-serif;font-size:.9rem;margin-top:8px}
        .ww-prop-input::placeholder{color:rgba(255,255,255,.3)}
        .vote-btn{display:inline-block;padding:5px 12px;background:rgba(183,28,28,.3);border:1px solid rgba(183,28,28,.5);border-radius:10px;color:#ef9a9a;font-size:.8rem;cursor:pointer;margin:3px;transition:.2s}
        .vote-btn:hover{background:rgba(183,28,28,.5)}
        @keyframes wwPulse{0%,100%{opacity:1}50%{opacity:.6}}
        .ww-phase-active{animation:wwPulse 2s ease-in-out infinite}

        header{
            background:linear-gradient(135deg,#4a1860 0%,#7B2D8B 40%,#4A90D9 80%,#E8395A 100%);
            background-size:300% 300%;animation:gradShift 9s ease infinite;
            padding:120px 5%;text-align:center;color:#fff;position:relative;overflow:hidden;
        }
        header::before{content:'';position:absolute;top:-60px;right:-60px;width:300px;height:300px;background:rgba(255,255,255,.04);border-radius:50%;pointer-events:none;animation:float 6s ease-in-out infinite}
        header::after{content:'';position:absolute;bottom:-50px;left:-50px;width:240px;height:240px;background:rgba(232,57,90,.07);border-radius:50%;pointer-events:none;animation:float 8s ease-in-out infinite reverse}
        header h1{font-size:3.5rem;font-weight:900;margin-bottom:20px;position:relative;z-index:1;animation:fadeInUp .8s ease}
        header p,header button{position:relative;z-index:1}

        section{padding:80px 5%;max-width:1400px;margin:0 auto}
        .section-title{text-align:center;font-size:2.5rem;font-weight:800;margin-bottom:50px;color:var(--text-primary)}

        .card{background:var(--bg-card);border-radius:18px;padding:30px;box-shadow:0 4px 20px var(--shadow);margin-bottom:30px;border:1px solid var(--border-color);transition:box-shadow .3s}
        .card:hover{box-shadow:0 8px 30px var(--shadow)}

        .stats-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;flex-wrap:wrap;gap:20px}
        .stats-title{font-size:1.8rem;font-weight:700;color:var(--primary)}
        .time-filter{display:flex;gap:12px}
        .time-filter-btn{padding:10px 20px;border:2px solid var(--border-color);background:var(--bg-main);color:var(--text-primary);border-radius:25px;cursor:pointer;font-weight:700;transition:.3s;font-family:'Nunito',sans-serif}
        .time-filter-btn:hover{transform:translateY(-1px)}
        .time-filter-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
        .chart-container{position:relative;height:400px}

        .create-post-card{background:var(--bg-card);border-radius:18px;padding:25px;box-shadow:0 4px 20px var(--shadow);margin-bottom:30px;border:1px solid var(--border-color)}
        .create-post-header{display:flex;gap:15px;margin-bottom:15px}
        .user-avatar{width:55px;height:55px;background:linear-gradient(135deg,#7B2D8B,#E8395A);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:1.3rem;flex-shrink:0;overflow:hidden;box-shadow:0 4px 12px rgba(123,45,139,.25)}
        .create-post-textarea{width:100%;min-height:100px;padding:16px;border:2px solid var(--border-color);background:var(--bg-card);color:var(--text-primary);border-radius:12px;font-family:'Nunito',sans-serif;font-size:1rem;transition:.3s}
        .create-post-textarea:focus{border-color:var(--primary);outline:none;box-shadow:0 0 0 3px rgba(123,45,139,.1)}
        .create-post-actions{display:flex;justify-content:space-between;margin-top:15px}
        .btn-upload{padding:10px 20px;background:var(--bg-main);color:var(--primary);border:2px solid var(--border-color);border-radius:25px;cursor:pointer;font-weight:700;transition:.3s;font-family:'Nunito',sans-serif}
        .btn-upload:hover{border-color:var(--primary);background:var(--secondary)}
        .btn-post{padding:12px 32px;background:linear-gradient(135deg,#7B2D8B,#E8395A);color:#fff;border:none;border-radius:25px;font-weight:800;cursor:pointer;transition:.3s;font-family:'Nunito',sans-serif}
        .btn-post:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(123,45,139,.3)}
        .image-preview-box{margin-top:15px;position:relative}
        .image-preview{max-width:100%;max-height:400px;border-radius:12px}
        .remove-img-btn{position:absolute;top:15px;right:15px;background:var(--danger);color:#fff;border:none;width:40px;height:40px;border-radius:50%;cursor:pointer;font-size:1.2rem}

        /* === POST CARD === */
        .post-card{background:var(--bg-card);border-radius:18px;padding:25px;box-shadow:0 4px 20px var(--shadow);margin-bottom:25px;border:1px solid var(--border-color);transition:transform .3s,box-shadow .3s;animation:fadeInUp .5s ease}
        .post-card:hover{transform:translateY(-3px);box-shadow:0 8px 28px var(--shadow)}
        .post-header{display:flex;gap:15px;margin-bottom:20px;justify-content:space-between;align-items:flex-start}
        .post-user-info{flex:1}
        .post-user-name{font-weight:800;font-size:1.1rem;color:var(--text-primary)}
        .post-user-meta{font-size:.9rem;color:var(--text-secondary);font-weight:600}
        .post-content{margin-bottom:20px;line-height:1.7;color:var(--text-primary);font-weight:600}
        .post-image{width:100%;border-radius:12px;margin-top:15px;cursor:pointer;max-height:500px;object-fit:cover;transition:transform .3s}
        .post-image:hover{transform:scale(1.01)}
        .post-actions{display:flex;gap:25px;padding-top:20px;border-top:2px solid var(--border-color)}
        .post-action-btn{background:none;border:none;cursor:pointer;padding:10px 20px;border-radius:25px;font-weight:700;color:var(--text-secondary);display:flex;gap:8px;transition:.3s;font-family:'Nunito',sans-serif}
        .post-action-btn:hover{background:var(--secondary);color:var(--primary)}
        .post-action-btn.liked{color:var(--danger)}
        .post-delete-btn{background:var(--danger);color:#fff;padding:8px 16px;border-radius:20px;font-size:.85rem;border:none;cursor:pointer;font-weight:700;font-family:'Nunito',sans-serif}
        /* Avatar di post  klikable */
        .post-avatar-link{cursor:pointer;transition:transform .2s;flex-shrink:0}
        .post-avatar-link:hover{transform:scale(1.08)}

        .modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(45,27,61,.75);z-index:2000;justify-content:center;align-items:center;overflow-y:auto;padding:20px;backdrop-filter:blur(3px)}
        .modal-content{background:var(--bg-card);padding:40px;border-radius:22px;width:100%;max-width:550px;position:relative;margin:auto;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(45,27,61,.25);animation:fadeInUp .3s ease}
        .modal-large{max-width:900px}
        .close-btn{position:absolute;top:20px;right:25px;font-size:28px;cursor:pointer;color:var(--text-secondary);background:none;border:none;z-index:10;transition:.3s;font-weight:700}
        .close-btn:hover{color:var(--danger);transform:scale(1.2)}

        .form-step{display:none}.form-step.active{display:block}
        .form-group{margin-bottom:20px}
        .form-group label{display:block;margin-bottom:8px;font-weight:800;color:var(--text-primary)}
        .form-group input,.form-group textarea,.form-group select{width:100%;padding:14px 18px;border:2px solid var(--border-color);background:var(--bg-card);color:var(--text-primary);border-radius:12px;font-family:'Nunito',sans-serif;font-size:1rem;transition:.3s}
        .form-group input:focus,.form-group textarea:focus,.form-group select:focus{border-color:var(--primary);outline:none;box-shadow:0 0 0 3px rgba(123,45,139,.1)}
        .btn-full{width:100%;padding:16px;background:linear-gradient(135deg,#7B2D8B,#E8395A);color:#fff;border:none;border-radius:12px;cursor:pointer;font-size:1.1rem;font-weight:800;margin-top:15px;font-family:'Nunito',sans-serif;transition:.3s}
        .btn-full:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(123,45,139,.25);opacity:.95}
        .alert{padding:15px 20px;border-radius:12px;margin-bottom:20px;font-weight:700}
        .alert-danger{background:#ffe6e6;color:var(--danger);border:2px solid var(--danger)}
        .alert-success{background:#d4edda;color:var(--success);border:2px solid var(--success)}

        .team-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:30px}
        .team-card-coc{background:linear-gradient(135deg,#1a1a2e,#16213e);border:2px solid rgba(123,45,139,.5);border-radius:20px;cursor:pointer;transition:transform .35s,box-shadow .35s,border-color .35s;overflow:hidden;box-shadow:0 8px 30px rgba(0,0,0,.4)}
        .team-card-coc:hover{transform:translateY(-10px) scale(1.02);box-shadow:0 16px 50px rgba(123,45,139,.4);border-color:#E8395A}
        .team-logo-coc{width:80px;height:80px;background:linear-gradient(135deg,#7B2D8B,#E8395A);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2rem;margin:0 auto 15px;font-weight:900;border:3px solid rgba(255,255,255,.25);overflow:hidden;animation:pulse 3s ease-in-out infinite}
        .team-logo-coc img{width:100%;height:100%;object-fit:cover;border-radius:50%}

        table{width:100%;border-collapse:collapse;background:var(--bg-card);border-radius:14px;overflow:hidden;box-shadow:0 4px 20px var(--shadow)}
        th,td{padding:18px;text-align:left;border-bottom:1px solid var(--border-color);color:var(--text-primary)}
        th{background:linear-gradient(135deg,#7B2D8B,#E8395A);color:#fff;font-weight:800}
        /* Baris leaderboard klikable */
        tr.clickable-row{cursor:pointer;transition:background .2s}
        tr.clickable-row:hover{background:var(--secondary)!important}

        .badge-icon{width:35px;height:35px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:1.2rem;border:2px solid rgba(255,255,255,.3);overflow:hidden;margin:2px;transition:transform .2s}
        .badge-icon:hover{transform:scale(1.2)}
        .badge-icon img{width:100%;height:100%;object-fit:cover}
        .role-ketua{background:linear-gradient(135deg,#7B2D8B,#E8395A);color:#fff;font-size:.8rem;padding:4px 12px;border-radius:20px;font-weight:700}
        .role-anggota{background:var(--border-color);color:var(--text-secondary);font-size:.8rem;padding:4px 12px;border-radius:20px;font-weight:600}
        .point-badge{display:inline-block;padding:4px 12px;border-radius:12px;font-size:.8rem;font-weight:700}
        .point-latihan{background:#fff3cd;color:#856404}
        .point-karya{background:#cfe2ff;color:#084298}
        .point-lomba{background:#d1e7dd;color:#0f5132}

        .btn-icon{background:linear-gradient(135deg,#7B2D8B,#E8395A);color:#fff;border:none;padding:12px 20px;border-radius:12px;cursor:pointer;font-weight:800;display:flex;align-items:center;gap:8px;transition:.3s;justify-content:center;font-family:'Nunito',sans-serif}
        .btn-icon:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(123,45,139,.3)}

        .copied-toast{position:fixed;bottom:30px;right:30px;background:linear-gradient(135deg,#7B2D8B,#E8395A);color:#fff;padding:15px 25px;border-radius:14px;font-weight:800;z-index:9999;display:none;animation:slideIn .3s ease;box-shadow:0 8px 24px rgba(123,45,139,.3)}

        .tab-btn{flex:1;padding:15px;background:transparent;border:none;cursor:pointer;font-weight:700;color:var(--text-secondary);border-bottom:3px solid transparent;white-space:nowrap;min-width:80px;transition:.3s;font-family:'Nunito',sans-serif}
        .tab-btn.active{color:var(--primary);border-bottom-color:var(--primary)}
        .tab-btn:hover{color:var(--primary)}

        .logo-upload-area{border:2px dashed var(--primary);border-radius:12px;padding:25px;text-align:center;cursor:pointer;transition:.3s;background:var(--bg-main)}
        .logo-upload-area:hover{background:var(--secondary);border-color:#E8395A}

        .emoji-btn{background:var(--bg-main);border:2px solid var(--border-color);border-radius:8px;padding:8px;cursor:pointer;font-size:1.4rem;transition:.2s;width:100%}
        .emoji-btn:hover,.emoji-btn.selected{background:var(--secondary);border-color:var(--primary);transform:scale(1.1)}
        .color-opt{width:38px;height:38px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:.2s;display:inline-block}
        .color-opt:hover,.color-opt.selected{border-color:var(--dark)!important;transform:scale(1.15)}
        .badge-card{background:var(--bg-main);border:2px solid var(--border-color);border-radius:12px;padding:15px;margin-bottom:12px;display:flex;align-items:center;gap:15px;transition:.3s}
        .badge-card:hover{border-color:var(--primary)}

        /* === SEARCH PANEL === */
        .search-user-item{display:flex;align-items:center;gap:14px;padding:14px;border-radius:14px;cursor:pointer;transition:.2s;border:1px solid var(--border-color);margin-bottom:10px;background:var(--bg-card)}
        .search-user-item:hover{background:var(--secondary);border-color:var(--primary)}
        .search-avatar-sm{width:50px;height:50px;border-radius:50%;overflow:hidden;background:linear-gradient(135deg,#7B2D8B,#E8395A);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:1.1rem;flex-shrink:0}
        .search-avatar-sm img{width:100%;height:100%;object-fit:cover}

        /* === VIEW PROFILE MODAL (read-only) === */
        #viewProfileModal .profile-hero{background:linear-gradient(135deg,#7B2D8B,#4A90D9);color:#fff;padding:40px;text-align:center;border-radius:18px 18px 0 0}
        #viewProfileModal .profile-body{padding:30px}

        @media(max-width:768px){header h1{font-size:2.2rem}.nav-links{gap:10px;flex-wrap:wrap}.team-grid{grid-template-columns:1fr}.chart-container{height:300px}.modal-content{padding:20px}}
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">? Memuat data...</div>
    </div>

    <nav>
        <div class="logo" onclick="scrollToSection('home')">
            <img src="https://i.imgur.com/wz811e4.png" alt="Grup Karya" class="logo-img" onerror="this.style.display='none'">
            <span>GRUP KARYA</span>
        </div>
        <div class="nav-links">
            <a onclick="scrollToSection('beranda')">?? Beranda</a>
            <a onclick="openTeamListModal()">?? Tim</a>
            <a onclick="scrollToSection('leaderboard')">?? Klasemen</a>
            <button class="btn-search-nav" onclick="openSearchModal()" title="Cari Pengguna">??</button>
            <button class="btn-game-nav" onclick="openGameListModal()" title="Mini Game">?? Game</button>
            <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">??</button>
            <div id="navGuest" style="display:flex;gap:12px">
                <button onclick="openLoginModal()" class="btn-nav">?? Masuk</button>
                <button onclick="openRegisterModal()" class="btn-nav">? Daftar</button>
            </div>
            <div id="navUser" style="display:none">
                <div class="user-pill" id="userPillBtn" onclick="openUserProfile()">
                    MODE <span id="navUserName">User</span>
                </div>
            </div>
        </div>
    </nav>

    <header id="home">
        <img src="https://i.imgur.com/wz811e4.png" alt="Grup Karya Logo"
             style="height:140px;object-fit:contain;margin-bottom:20px;filter:drop-shadow(0 8px 20px rgba(0,0,0,.3));animation:float 5s ease-in-out infinite;position:relative;z-index:1"
             onerror="this.style.display='none'">
        <h1>Dari Minat, Jadi Karya Nyata</h1>
        <p style="font-size:1.3rem;opacity:.9;font-weight:600;position:relative;z-index:1">Platform Kolaborasi Mahasiswa Sastra Indonesia</p>
        <button onclick="checkLoginAction()" class="btn-nav" style="font-size:1.1rem;padding:14px 40px;margin-top:25px;position:relative;z-index:1">?? Mulai Sekarang</button>
    </header>

    <section id="beranda">
        <div class="card">
            <div class="stats-header">
                <h2 class="stats-title">?? Perkembangan Poin</h2>
                <div class="time-filter">
                    <button class="time-filter-btn active" onclick="changeTimeFilter('weekly',event)">Mingguan</button>
                    <button class="time-filter-btn" onclick="changeTimeFilter('monthly',event)">Bulanan</button>
                </div>
            </div>
            <div class="chart-container"><canvas id="statsChart"></canvas></div>
        </div>

        <div id="createPostSection" style="display:none">
            <div class="create-post-card">
                <div class="create-post-header">
                    <div class="user-avatar" id="createAvatar">A</div>
                    <div style="flex:1">
                        <textarea class="create-post-textarea" id="postInput" placeholder="? Apa yang ingin kamu bagikan hari ini?"></textarea>
                        <div id="imgPreviewBox" style="display:none" class="image-preview-box">
                            <img id="imgPreview" class="image-preview" src="">
                            <button class="remove-img-btn" onclick="removeImage()">&times;</button>
                        </div>
                    </div>
                </div>
                <div class="create-post-actions">
                    <button class="btn-upload" onclick="document.getElementById('fileInput').click()">??? Upload Foto</button>
                    <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="previewImage(event)">
                    <button class="btn-post" onclick="createPost()">?? Posting</button>
                </div>
            </div>
        </div>

        <div id="loginPromptSection" style="display:none">
            <div style="background:#fff3cd;border:3px dashed var(--warning);border-radius:16px;padding:40px;text-align:center;margin-bottom:30px">
                <h3 style="color:#856404;font-size:1.8rem;margin-bottom:15px">?? Login untuk Berbagi Karya</h3>
                <p style="color:#856404">Bergabung dan bagikan karyamu!</p>
                <button class="btn-nav" onclick="openLoginModal()" style="margin-top:15px;padding:12px 32px">Masuk Sekarang</button>
            </div>
        </div>
        <div id="feedContainer"></div>
    </section>

    <section id="leaderboard" style="background:linear-gradient(135deg,#1a0a25,#0f0a15);padding-top:80px;padding-bottom:80px;max-width:100%">
        <div style="max-width:1400px;margin:0 auto;padding:0 5%">
            <h2 class="section-title" style="color:#fff">?? Klasemen Tim</h2>
            <div style="overflow-x:auto">
                <table><thead><tr><th>Rank</th><th>Tim</th><th>Fokus</th><th>Lencana</th><th>Poin</th></tr></thead>
                <tbody id="teamTableBody"></tbody></table>
            </div>
        </div>
    </section>

    <section id="individu">
        <h2 class="section-title">? Klasemen Individu</h2>
        <div style="overflow-x:auto">
            <table><thead><tr><th>Nama</th><th>Tim</th><th>Peran</th><th>Poin</th></tr></thead>
            <tbody id="individuTableBody"></tbody></table>
        </div>
    </section>

    <footer style="background:linear-gradient(135deg,#1a0a25,#2d1b35);color:white;padding:40px 5%;text-align:center">
        <img src="https://i.imgur.com/wz811e4.png" alt="Grup Karya"
             style="height:55px;object-fit:contain;margin-bottom:12px;filter:drop-shadow(0 2px 8px rgba(255,255,255,.15))"
             onerror="this.style.display='none'">
        <p style="font-size:1.2rem;font-weight:800">GRUP KARYA</p>
        <p style="opacity:.6;margin-top:8px;font-weight:600">© 2026 Platform Kolaborasi Mahasiswa</p>
    </footer>

    <!-- LOGIN MODAL -->
    <div id="loginModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('loginModal')">&times;</button>
            <h2 style="text-align:center;margin-bottom:30px;color:var(--primary)">?? Masuk ke Akun</h2>
            <div id="loginAlert"></div>
            <div class="form-group"><label>NIM</label><input type="text" id="loginNim" placeholder="Contoh: 12345678" onkeypress="if(event.key==='Enter')processLogin()"></div>
            <div class="form-group"><label>Password</label><input type="password" id="loginPass" placeholder="Masukkan password" onkeypress="if(event.key==='Enter')processLogin()"></div>
            <button class="btn-full" onclick="processLogin()">?? Masuk</button>
            <p style="text-align:center;margin-top:20px;color:var(--text-secondary)">
                Belum punya akun? <a onclick="switchModal('loginModal','registerModal')" style="color:var(--primary);cursor:pointer;font-weight:700">? Daftar di sini</a>
            </p>
        </div>
    </div>

    <!-- REGISTER MODAL -->
    <div id="registerModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('registerModal')">&times;</button>
            <div id="regStep1" class="form-step active">
                <h3 style="margin-bottom:5px;color:var(--text-primary)">?? Langkah 1/3</h3>
                <p style="color:var(--text-secondary);margin-bottom:20px">Data Diri</p>
                <div id="regAlert"></div>
                <div class="form-group"><label>Nama Lengkap *</label><input type="text" id="regNama" placeholder="Budi Santoso"></div>
                <div class="form-group"><label>NIM *</label><input type="text" id="regNim" placeholder="12345678"></div>
                <div class="form-group"><label>Kelas</label><input type="text" id="regKelas" placeholder="TI-3A"></div>
                <button class="btn-full" onclick="regNext1()">Lanjut ??</button>
            </div>
            <div id="regStep2" class="form-step">
                <h3 style="margin-bottom:5px;color:var(--text-primary)">?? Langkah 2/3</h3>
                <p style="color:var(--text-secondary);margin-bottom:20px">Keamanan Akun</p>
                <div id="regAlert2"></div>
                <div class="form-group"><label>Password * (min 6 karakter)</label><input type="password" id="regPass" placeholder="Minimal 6 karakter"></div>
                <div class="form-group"><label>Konfirmasi Password *</label><input type="password" id="regPassConfirm" placeholder="Ketik ulang password"></div>
                <div style="background:var(--bg-main);padding:15px;border-radius:12px;margin:15px 0;display:flex;align-items:center;gap:10px">
                    <input type="checkbox" id="robotCheck" style="width:20px;height:20px;accent-color:var(--primary)">
                    <label for="robotCheck" style="display:inline;font-weight:normal;color:var(--text-primary);cursor:pointer">?? Saya bukan robot</label>
                </div>
                <button class="btn-full" onclick="regNext2()">Lanjut ??</button>
                <button class="btn-full" style="background:var(--gray);margin-top:8px" onclick="showStep('regStep1')">?? Kembali</button>
            </div>
            <div id="regStep3" class="form-step">
                <h3 style="margin-bottom:5px;color:var(--text-primary)">?? Langkah 3/3</h3>
                <p style="color:var(--text-secondary);margin-bottom:20px">Pilih Tim</p>
                <div style="background:var(--bg-main);padding:20px;border-radius:12px;margin-bottom:20px">
                    <p style="color:var(--text-secondary);font-size:.9rem">Halo <strong id="regNamaPreview" style="color:var(--primary)">-</strong>! Pilih bergabung ke tim yang ada atau buat tim baru.</p>
                </div>
                <button class="btn-full" style="background:var(--bg-card);color:var(--primary);border:2px solid var(--primary);margin-bottom:10px" onclick="goToJoinList()">?? Bergabung ke Tim yang Ada</button>
                <button class="btn-full" style="background:var(--success)" onclick="showStep('panelCreateTeam')">?? Buat Tim Baru</button>
                <button class="btn-full" style="background:var(--gray);margin-top:8px" onclick="showStep('regStep2')">?? Kembali</button>
            </div>
            <div id="panelJoinTeam" class="form-step">
                <h3 style="margin-bottom:20px;color:var(--text-primary)">?? Pilih Tim</h3>
                <div id="joinListContainer" style="height:300px;overflow-y:auto;border:2px solid var(--border-color);border-radius:12px;padding:10px;margin:15px 0;background:var(--bg-main)"></div>
                <button class="btn-full" style="background:var(--success)" onclick="finalJoinTeam()">? Konfirmasi Bergabung</button>
                <button class="btn-full" style="background:var(--gray);margin-top:8px" onclick="showStep('regStep3')">?? Kembali</button>
            </div>
            <div id="panelCreateTeam" class="form-step">
                <h3 style="margin-bottom:20px;color:var(--text-primary)">?? Buat Tim Baru</h3>
                <div class="form-group"><label>Nama Tim *</label><input type="text" id="newTeamName" placeholder="Alpha Creative"></div>
                <div class="form-group"><label>Fokus Kegiatan *</label><input type="text" id="newTeamFocus" placeholder="Film & Media"></div>
                <div class="form-group"><label>Visi & Misi</label><textarea id="newTeamVisi" rows="3" placeholder="Menjadi tim terbaik..."></textarea></div>
                <div class="form-group"><label>Arah Pengembangan</label><input type="text" id="newTeamDev" placeholder="Produksi Film Pendek"></div>
                <button class="btn-full" style="background:var(--success)" onclick="finalCreateTeam()">?? Buat Tim & Daftar</button>
                <button class="btn-full" style="background:var(--gray);margin-top:8px" onclick="showStep('regStep3')">?? Kembali</button>
            </div>
        </div>
    </div>

    <!-- USER PROFILE MODAL -->
    <div id="userProfileModal" class="modal-overlay">
        <div class="modal-content modal-large" style="max-width:850px;padding:0">
            <button class="close-btn" onclick="closeModal('userProfileModal')" style="z-index:10">&times;</button>
            <!-- ADMIN PANEL -->
            <div id="adminPanelSection" style="display:none;padding:40px">
                <div style="background:linear-gradient(135deg,#dc3545,#c82333);color:#fff;padding:30px;border-radius:16px">
                    <h2 style="margin-bottom:10px">?? ADMIN PANEL</h2>
                    <p style="opacity:.9;margin-bottom:20px">Akses penuh sistem</p>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px">
                        <button onclick="adminAddPoints()" style="background:#fff;color:#dc3545;padding:15px;border:none;border-radius:12px;font-weight:700;cursor:pointer;font-family:'Nunito',sans-serif;transition:.3s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">? Tambah Poin</button>
                        <button onclick="adminAddBadge()" style="background:#fff;color:#dc3545;padding:15px;border:none;border-radius:12px;font-weight:700;cursor:pointer;font-family:'Nunito',sans-serif;transition:.3s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">?? Kirim Lencana</button>
                        <button onclick="openDesainLencana()" style="background:#fff;color:#dc3545;padding:15px;border:none;border-radius:12px;font-weight:700;cursor:pointer;font-family:'Nunito',sans-serif;transition:.3s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">?? Desain Lencana</button>
                        <button onclick="lihatDaftarLencana()" style="background:#fff;color:#dc3545;padding:15px;border:none;border-radius:12px;font-weight:700;cursor:pointer;font-family:'Nunito',sans-serif;transition:.3s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">?? Daftar Lencana</button>
                        <button onclick="downloadExcelData()" style="background:#fff;color:#dc3545;padding:15px;border:none;border-radius:12px;font-weight:700;cursor:pointer;font-family:'Nunito',sans-serif;transition:.3s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">?? Download Excel</button>
                        <button onclick="adminDeleteTeam()" style="background:#fff;color:#dc3545;padding:15px;border:none;border-radius:12px;font-weight:700;cursor:pointer;font-family:'Nunito',sans-serif;transition:.3s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">??? Hapus Tim</button>
                        <button onclick="adminDeleteUser()" style="background:#fff;color:#dc3545;padding:15px;border:none;border-radius:12px;font-weight:700;cursor:pointer;font-family:'Nunito',sans-serif;transition:.3s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">?? Hapus User</button>
                        <button onclick="adminDeletePost()" style="background:#fff;color:#dc3545;padding:15px;border:none;border-radius:12px;font-weight:700;cursor:pointer;font-family:'Nunito',sans-serif;transition:.3s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">??? Hapus Post</button>
                    </div>
                    <button class="btn-full" style="background:rgba(0,0,0,.3);margin-top:25px;border:2px solid rgba(255,255,255,.3)" onclick="processLogout()">?? Keluar Admin</button>
                </div>
            </div>
            <!-- CV PROFILE -->
            <div id="cvProfileSection" style="background:var(--bg-card)">
                <div style="background:linear-gradient(135deg,#7B2D8B,#4A90D9);color:#fff;padding:40px;text-align:center">
                    <div id="cvAvatar" style="width:120px;height:120px;border-radius:50%;border:5px solid #fff;margin:0 auto 20px;background:#fff;color:var(--primary);display:flex;align-items:center;justify-content:center;font-size:3rem;font-weight:900;overflow:hidden">
                        <span id="cvAvatarText">A</span>
                    </div>
                    <div id="cvName" style="font-size:2.5rem;font-weight:900;margin-bottom:10px">User</div>
                    <div id="cvTitle" style="font-size:1.1rem;opacity:.9;margin-bottom:5px">-</div>
                    <div style="font-size:.9rem;opacity:.8"><span id="cvNim">NIM: -</span> | <span id="cvKelas">Kelas: -</span></div>
                </div>
                <div style="padding:40px">
                    <div style="margin-bottom:30px;padding-bottom:30px;border-bottom:2px solid var(--border-color)">
                        <div style="font-size:1.5rem;font-weight:700;color:var(--primary);margin-bottom:20px;display:flex;align-items:center;gap:10px">
                            <span style="width:4px;height:25px;background:linear-gradient(135deg,#7B2D8B,#E8395A);border-radius:2px;display:inline-block"></span>
                            ?? Informasi Profil
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
                            <div><div style="font-size:.85rem;color:var(--text-secondary);font-weight:600;margin-bottom:5px">Tim & Jabatan</div><div id="cvTeamRole" style="font-weight:500;color:var(--text-primary)">-</div></div>
                            <div><div style="font-size:.85rem;color:var(--text-secondary);font-weight:600;margin-bottom:5px">Total Poin</div><div id="cvPoints" style="color:var(--success);font-weight:700;font-size:1.3rem">0</div></div>
                            <div><div style="font-size:.85rem;color:var(--text-secondary);font-weight:600;margin-bottom:5px">Peringkat</div><div id="cvRank" style="font-weight:500;color:var(--text-primary)">-</div></div>
                        </div>
                    </div>
                    <div style="margin-bottom:30px;padding-bottom:30px;border-bottom:2px solid var(--border-color)">
                        <div style="font-size:1.5rem;font-weight:700;color:var(--primary);margin-bottom:20px;display:flex;align-items:center;gap:10px">
                            <span style="width:4px;height:25px;background:linear-gradient(135deg,#7B2D8B,#E8395A);border-radius:2px;display:inline-block"></span>
                            ?? Prestasi
                        </div>
                        <div id="cvAchievements"><p style="color:var(--text-secondary);text-align:center;padding:20px">Belum ada prestasi</p></div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
                        <button class="btn-full" style="margin-top:0;background:var(--gray)" onclick="downloadCV()">?? Download CV</button>
                        <button class="btn-full" style="margin-top:0;background:var(--purple)" onclick="openEditProfile()">?? Edit Profil</button>
                    </div>
                    <button class="btn-full" style="margin-top:12px" onclick="openMyTeamPage()">?? Laman Tim Saya</button>
                    <button class="btn-full" style="background:var(--danger);margin-top:12px" onclick="processLogout()">?? Keluar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- EDIT PROFILE MODAL -->
    <div id="editProfileModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('editProfileModal')">&times;</button>
            <h2 style="text-align:center;margin-bottom:20px;color:var(--primary)">?? Edit Profil</h2>
            <div class="logo-upload-area" onclick="document.getElementById('profilePhotoInput').click()">
                <div id="editProfilePreview" style="width:100px;height:100px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-size:2.5rem;font-weight:700;margin:0 auto 12px;overflow:hidden"><span id="editProfileText">A</span></div>
                <p style="color:var(--primary);font-weight:700">?? Klik untuk ubah foto profil</p>
            </div>
            <input type="file" id="profilePhotoInput" accept="image/*" style="display:none" onchange="previewProfilePhoto(event)">
            <div class="form-group" style="margin-top:20px"><label>Nama Lengkap</label><input type="text" id="editName"></div>
            <div class="form-group"><label>Kelas</label><input type="text" id="editKelas" placeholder="TI-3A"></div>
            <button class="btn-full" style="background:var(--success)" onclick="saveProfile()">?? Simpan Perubahan</button>
            <button class="btn-full" style="background:var(--gray);margin-top:8px" onclick="closeModal('editProfileModal')">Batal</button>
        </div>
    </div>

    <!-- TEAM LIST MODAL -->
    <div id="teamListModal" class="modal-overlay">
        <div class="modal-content modal-large">
            <button class="close-btn" onclick="closeModal('teamListModal')">&times;</button>
            <h2 style="text-align:center;color:var(--gold);margin-bottom:30px">?? Daftar Semua Tim</h2>
            <div class="team-grid" id="allTeamsGrid"></div>
        </div>
    </div>

    <!-- TEAM DETAIL MODAL -->
    <div id="teamDetailModal" class="modal-overlay">
        <div class="modal-content modal-large">
            <button class="close-btn" onclick="closeModal('teamDetailModal')">&times;</button>
            <h2 id="detailName" style="color:var(--primary);font-size:2rem;text-align:center;margin-bottom:20px">Tim</h2>
            <div style="display:grid;grid-template-columns:200px 1fr;gap:30px;margin:30px 0">
                <div style="text-align:center">
                    <div id="detailLogoContainer" style="width:120px;height:120px;background:var(--primary);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:3rem;margin:0 auto 15px;font-weight:700;overflow:hidden">
                        <span id="detailLogoText">TM</span>
                    </div>
                    <div id="detailBadges" style="display:flex;gap:8px;justify-content:center;margin-top:15px;flex-wrap:wrap"></div>
                    <div style="display:flex;flex-direction:column;gap:10px;margin-top:20px">
                        <button class="btn-icon" id="joinOrChatBtn" onclick="handleJoinOrChat()" style="width:100%"><span id="joinBtnText">?? Bergabung</span></button>
                        <button class="btn-icon" onclick="shareTeamLink()" style="width:100%;background:var(--purple)">?? Share</button>
                        <button class="btn-icon" id="leaveTeamBtn" style="background:var(--danger);display:none;width:100%" onclick="leaveTeam()">?? Keluar Tim</button>
                    </div>
                </div>
                <div>
                    <div style="margin-bottom:15px"><div style="font-weight:700;color:var(--primary);margin-bottom:5px">?? Visi & Misi</div><div id="detailVisi" style="color:var(--text-primary)">-</div></div>
                    <div style="margin-bottom:15px"><div style="font-weight:700;color:var(--primary);margin-bottom:5px">?? Fokus</div><div id="detailFocus" style="color:var(--text-primary)">-</div></div>
                    <div style="margin-bottom:15px"><div style="font-weight:700;color:var(--primary);margin-bottom:5px">? Poin</div><div><span id="detailPoints" style="font-size:1.5rem;color:var(--success);font-weight:700">0</span> poin (Rank #<span id="detailRank">1</span>)</div></div>
                    <div><div style="font-weight:700;color:var(--primary);margin-bottom:5px">?? Anggota</div><div id="detailMemberCount" style="color:var(--text-primary)">0 anggota</div></div>
                </div>
            </div>
            <div style="display:flex;border-bottom:3px solid var(--border-color);margin-bottom:30px;overflow-x:auto">
                <button class="tab-btn active" onclick="switchTeamTab('info')">?? Info</button>
                <button class="tab-btn" onclick="switchTeamTab('members')">?? Anggota</button>
                <button class="tab-btn" onclick="switchTeamTab('activities')">?? Log</button>
                <button class="tab-btn" onclick="switchTeamTab('chat')">?? Chat</button>
                <button class="tab-btn" id="manageTab" onclick="switchTeamTab('manage')" style="display:none">?? Kelola</button>
            </div>
            <div id="tabInfo" style="display:block"><h4 style="color:var(--primary);margin-bottom:10px">??? Arah Pengembangan</h4><p id="detailDev" style="color:var(--text-primary)">-</p></div>
            <div id="tabMembers" style="display:none"><h4 style="color:var(--primary);margin-bottom:10px">?? Daftar Anggota</h4><div id="membersList"></div></div>
            <div id="tabActivities" style="display:none">
                <h4 style="color:var(--primary);margin-bottom:10px">?? Riwayat Kegiatan</h4>
                <div style="overflow-x:auto"><table><thead><tr><th>Kegiatan</th><th>Tanggal</th></tr></thead><tbody id="activityLogBody"></tbody></table></div>
            </div>
            <div id="tabChat" style="display:none">
                <div id="chatAccessDenied" style="background:#ffe6e6;padding:25px;text-align:center;border-radius:12px;color:var(--danger);display:none"><h3>?? Chat hanya untuk anggota tim</h3></div>
                <div id="chatAccessGranted" style="display:none">
                    <div style="background:var(--bg-card);border:2px solid var(--border-color);border-radius:16px;height:450px;display:flex;flex-direction:column">
                        <div style="background:linear-gradient(135deg,#7B2D8B,#E8395A);color:#fff;padding:15px 20px;border-radius:14px 14px 0 0;font-weight:700">?? Chat Tim - <span id="chatTeamName">Tim</span></div>
                        <div id="chatMessages" style="flex:1;padding:15px;overflow-y:auto;background:var(--bg-main)"></div>
                        <div style="display:flex;padding:12px;border-top:2px solid var(--border-color);gap:10px;background:var(--bg-card);border-radius:0 0 14px 14px">
                            <input type="text" id="chatInput" placeholder="?? Ketik pesan..." style="flex:1;padding:10px 18px;border:2px solid var(--border-color);background:var(--bg-main);color:var(--text-primary);border-radius:25px;font-family:'Nunito',sans-serif" onkeypress="if(event.key==='Enter')sendMessage()">
                            <button onclick="sendMessage()" style="padding:10px 22px;background:linear-gradient(135deg,#7B2D8B,#E8395A);color:#fff;border:none;border-radius:25px;cursor:pointer;font-weight:700;font-family:'Nunito',sans-serif">Kirim</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="tabManage" style="display:none">
                <div style="padding:20px;background:var(--bg-main);border:2px dashed var(--warning);border-radius:12px">
                    <h4 style="color:var(--text-primary);margin-bottom:15px">?? Kelola Anggota Tim</h4>
                    <div id="manageMembers"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- TEAM SETTINGS -->
    <div id="teamSettingsModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('teamSettingsModal')">&times;</button>
            <h2 style="text-align:center;margin-bottom:20px;color:var(--warning)">?? Pengaturan Tim</h2>
            <div class="logo-upload-area" onclick="document.getElementById('teamLogoInput').click()">
                <div id="teamLogoPreview" style="width:100px;height:100px;background:var(--primary);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2.5rem;margin:0 auto 12px;font-weight:700;overflow:hidden"><span id="teamLogoText">TM</span></div>
                <p style="color:var(--primary);font-weight:700">??? Klik untuk upload logo tim</p>
            </div>
            <input type="file" id="teamLogoInput" accept="image/*" style="display:none" onchange="previewTeamLogo(event)">
            <div class="form-group" style="margin-top:15px"><label>Nama Tim</label><input type="text" id="settingsName"></div>
            <div class="form-group"><label>Visi & Misi</label><textarea id="settingsVisi" rows="3"></textarea></div>
            <div class="form-group"><label>Fokus Kegiatan</label><input type="text" id="settingsFocus"></div>
            <div class="form-group"><label>Arah Pengembangan</label><input type="text" id="settingsDev"></div>
            <div class="form-group"><label>?? Aktifkan Lencana (Max 3)</label><div id="settingsBadgesList" style="margin-top:8px"></div></div>
            <button class="btn-full" style="background:var(--success)" onclick="saveTeamSettings()">?? Simpan Pengaturan</button>
        </div>
    </div>

    <!-- ADMIN: TAMBAH POIN -->
    <div id="addPointsModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('addPointsModal')">&times;</button>
            <h2 style="text-align:center;margin-bottom:20px;color:var(--success)">? Tambah Poin</h2>
            <div class="form-group"><label>Pilih Tim *</label><select id="pointTeamSelect" onchange="loadTeamMembers()"><option value="">-- Pilih Tim --</option></select></div>
            <div class="form-group"><label>Pilih Anggota *</label><select id="pointMemberSelect"><option value="">-- Pilih tim dulu --</option></select></div>
            <div class="form-group"><label>Jenis Prestasi *</label>
                <select id="pointTypeSelect">
                    <option value="">-- Pilih Jenis --</option>
                    <option value="latihan">?? Latihan Wajib (+30 poin)</option>
                    <option value="karya">?? Karya (+50 poin)</option>
                    <option value="lomba">?? Lomba (+70 poin)</option>
                </select>
            </div>
            <div class="form-group"><label>Deskripsi Prestasi *</label><textarea id="pointDesc" rows="3" placeholder="Juara 1 Lomba Fotografi..."></textarea></div>
            <button class="btn-full" style="background:var(--success)" onclick="submitAddPoints()">? Tambahkan Poin</button>
        </div>
    </div>

    <!-- ADMIN: KIRIM LENCANA -->
    <div id="addBadgeModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('addBadgeModal')">&times;</button>
            <h2 style="text-align:center;margin-bottom:20px;color:var(--warning)">?? Kirim Lencana ke Tim</h2>
            <div class="form-group"><label>Pilih Tim *</label><select id="badgeTeamSelect"><option value="">-- Pilih Tim --</option></select></div>
            <div class="form-group"><label>Pilih Lencana *</label><select id="badgeTypeSelect"><option value="">-- Pilih Lencana --</option></select></div>
            <div id="badgePreviewBox" style="display:none;margin:15px 0;padding:15px;background:var(--bg-main);border-radius:12px;text-align:center">
                <div id="badgeSendPreview" style="width:60px;height:60px;border-radius:50%;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;font-size:1.8rem"></div>
                <div id="badgeSendName" style="font-weight:700;color:var(--text-primary)"></div>
            </div>
            <button class="btn-full" style="background:var(--warning);color:#000" onclick="submitAddBadge()">?? Kirim Lencana</button>
        </div>
    </div>

    <!-- ADMIN: DESAIN LENCANA -->
    <div id="desainLencanaModal" class="modal-overlay">
        <div class="modal-content modal-large" style="max-width:750px">
            <button class="close-btn" onclick="closeModal('desainLencanaModal')">&times;</button>
            <h2 style="text-align:center;margin-bottom:5px;color:var(--primary)">?? Desain Lencana Baru</h2>
            <p style="text-align:center;color:var(--text-secondary);margin-bottom:25px">Buat lencana custom untuk dikirim ke tim</p>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:25px">
                <div>
                    <div class="form-group"><label>Nama Lencana *</label><input type="text" id="badgeNameInput" placeholder="Contoh: Juara Lomba 2026" oninput="updateBadgePreview()"></div>
                    <div class="form-group">
                        <label>Pilih Emoji</label>
                        <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin-bottom:10px">
                            <button onclick="selectEmoji('??')" class="emoji-btn">??</button>
                            <button onclick="selectEmoji('?')" class="emoji-btn">?</button>
                            <button onclick="selectEmoji('??')" class="emoji-btn">??</button>
                            <button onclick="selectEmoji('??')" class="emoji-btn">??</button>
                            <button onclick="selectEmoji('??')" class="emoji-btn">??</button>
                            <button onclick="selectEmoji('??')" class="emoji-btn">??</button>
                            <button onclick="selectEmoji('??')" class="emoji-btn">??</button>
                            <button onclick="selectEmoji('??')" class="emoji-btn">??</button>
                            <button onclick="selectEmoji('??')" class="emoji-btn">??</button>
                            <button onclick="selectEmoji('??')" class="emoji-btn">??</button>
                            <button onclick="selectEmoji('??')" class="emoji-btn">??</button>
                            <button onclick="selectEmoji('??')" class="emoji-btn">??</button>
                            <button onclick="selectEmoji('??')" class="emoji-btn">??</button>
                            <button onclick="selectEmoji('??')" class="emoji-btn">??</button>
                            <button onclick="selectEmoji('??')" class="emoji-btn">??</button>
                            <button onclick="selectEmoji('?')" class="emoji-btn">?</button>
                            <button onclick="selectEmoji('??')" class="emoji-btn">??</button>
                            <button onclick="selectEmoji('??')" class="emoji-btn">??</button>
                        </div>
                        <input type="text" id="badgeEmojiInput" placeholder="Atau ketik emoji sendiri..." oninput="updateBadgePreview()">
                    </div>
                    <div class="form-group">
                        <label>ATAU Upload Foto Lencana</label>
                        <div class="logo-upload-area" onclick="document.getElementById('badgePhotoInput').click()" style="padding:15px">
                            <p style="color:var(--primary);font-weight:700;margin:0;font-size:.9rem">?? Klik untuk upload foto (max 1MB)</p>
                        </div>
                        <input type="file" id="badgePhotoInput" accept="image/*" style="display:none" onchange="previewBadgePhoto(event)">
                        <div id="badgePhotoPreviewBox" style="display:none;margin-top:10px;text-align:center">
                            <img id="badgePhotoPreviewImg" style="width:60px;height:60px;border-radius:50%;object-fit:cover;border:3px solid var(--primary)">
                            <button onclick="clearBadgePhoto()" style="display:block;margin:8px auto 0;background:var(--danger);color:#fff;border:none;border-radius:8px;padding:4px 12px;cursor:pointer;font-size:.8rem;font-family:'Nunito',sans-serif">??? Hapus Foto</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Warna Latar Lencana</label>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
                            <div onclick="selectBadgeColor('linear-gradient(135deg,#ffd700,#ff8c00)')" class="color-opt" style="background:linear-gradient(135deg,#ffd700,#ff8c00)"></div>
                            <div onclick="selectBadgeColor('linear-gradient(135deg,#f44336,#b71c1c)')" class="color-opt" style="background:linear-gradient(135deg,#f44336,#b71c1c)"></div>
                            <div onclick="selectBadgeColor('linear-gradient(135deg,#4caf50,#1b5e20)')" class="color-opt" style="background:linear-gradient(135deg,#4caf50,#1b5e20)"></div>
                            <div onclick="selectBadgeColor('linear-gradient(135deg,#2196f3,#0d47a1)')" class="color-opt" style="background:linear-gradient(135deg,#2196f3,#0d47a1)"></div>
                            <div onclick="selectBadgeColor('linear-gradient(135deg,#9c27b0,#4a148c)')" class="color-opt" style="background:linear-gradient(135deg,#9c27b0,#4a148c)"></div>
                            <div onclick="selectBadgeColor('linear-gradient(135deg,#ff5722,#bf360c)')" class="color-opt" style="background:linear-gradient(135deg,#ff5722,#bf360c)"></div>
                            <div onclick="selectBadgeColor('linear-gradient(135deg,#00bcd4,#006064)')" class="color-opt" style="background:linear-gradient(135deg,#00bcd4,#006064)"></div>
                            <div onclick="selectBadgeColor('linear-gradient(135deg,#795548,#3e2723)')" class="color-opt" style="background:linear-gradient(135deg,#795548,#3e2723)"></div>
                            <div onclick="selectBadgeColor('linear-gradient(135deg,#607d8b,#263238)')" class="color-opt" style="background:linear-gradient(135deg,#607d8b,#263238)"></div>
                            <div onclick="selectBadgeColor('linear-gradient(135deg,#e91e63,#880e4f)')" class="color-opt" style="background:linear-gradient(135deg,#e91e63,#880e4f)"></div>
                        </div>
                    </div>
                </div>
                <div style="display:flex;flex-direction:column;align-items:center;padding-top:20px">
                    <div style="font-weight:700;color:var(--text-primary);margin-bottom:20px;font-size:1rem">? Preview Lencana</div>
                    <div id="badgePreviewLarge" style="width:120px;height:120px;border-radius:50%;background:linear-gradient(135deg,#ffd700,#ff8c00);display:flex;align-items:center;justify-content:center;font-size:3rem;margin-bottom:12px;border:4px solid rgba(255,255,255,.4);box-shadow:0 8px 25px rgba(0,0,0,.25);overflow:hidden"></div>
                    <div id="badgePreviewName" style="font-weight:700;color:var(--text-primary);font-size:1rem;text-align:center;margin-bottom:30px;min-height:24px">Nama Lencana</div>
                    <div style="font-size:.8rem;color:var(--text-secondary);margin-bottom:10px">Preview di leaderboard:</div>
                    <div style="display:flex;align-items:center;gap:10px;background:var(--bg-main);padding:12px 18px;border-radius:12px;border:2px solid var(--border-color)">
                        <div id="badgePreviewSmall" style="width:35px;height:35px;border-radius:50%;background:linear-gradient(135deg,#ffd700,#ff8c00);display:flex;align-items:center;justify-content:center;font-size:1.1rem;overflow:hidden"></div>
                        <span style="color:var(--text-primary);font-size:.9rem;font-weight:600" id="badgePreviewNameSmall">Nama Lencana</span>
                    </div>
                    <div style="margin-top:20px;padding:15px;background:var(--bg-main);border-radius:12px;border:2px dashed var(--border-color);width:100%;font-size:.85rem;color:var(--text-secondary)">
                        ?? <strong>Tips:</strong><br> Emoji untuk lencana ringan<br> Foto untuk lencana spesial<br> Pilih warna yang kontras
                    </div>
                </div>
            </div>
            <div style="border-top:2px solid var(--border-color);margin-top:25px;padding-top:20px">
                <button class="btn-full" style="background:var(--success);margin-top:0" onclick="simpanDesainLencana()">?? Simpan Lencana ke Daftar</button>
            </div>
        </div>
    </div>

    <!-- ADMIN: DAFTAR LENCANA CUSTOM -->
    <div id="daftarLencanaModal" class="modal-overlay">
        <div class="modal-content modal-large" style="max-width:700px">
            <button class="close-btn" onclick="closeModal('daftarLencanaModal')">&times;</button>
            <h2 style="text-align:center;margin-bottom:5px;color:var(--primary)">?? Daftar Lencana Custom</h2>
            <p style="text-align:center;color:var(--text-secondary);margin-bottom:20px">Semua lencana yang sudah dibuat admin</p>
            <button onclick="openDesainLencana()" class="btn-full" style="margin-bottom:20px;margin-top:0">?? Buat Lencana Baru</button>
            <div id="daftarLencanaList"></div>
        </div>
    </div>

    <!-- ADMIN: HAPUS TIM -->
    <div id="deleteTeamModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('deleteTeamModal')">&times;</button>
            <h2 style="text-align:center;margin-bottom:20px;color:var(--danger)">??? Hapus Tim</h2>
            <div id="deleteTeamList" style="max-height:400px;overflow-y:auto"></div>
        </div>
    </div>

    <!-- ADMIN: HAPUS USER -->
    <div id="deleteUserModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('deleteUserModal')">&times;</button>
            <h2 style="text-align:center;margin-bottom:20px;color:var(--danger)">?? Hapus User</h2>
            <div id="deleteUserList" style="max-height:400px;overflow-y:auto"></div>
        </div>
    </div>

    <!-- ADMIN: HAPUS POST -->
    <div id="deletePostModal" class="modal-overlay">
        <div class="modal-content modal-large">
            <button class="close-btn" onclick="closeModal('deletePostModal')">&times;</button>
            <h2 style="text-align:center;margin-bottom:20px;color:var(--danger)">??? Hapus Postingan</h2>
            <div id="deletePostList" style="max-height:450px;overflow-y:auto"></div>
        </div>
    </div>

    <!-- ===== MODAL BARU: CARI PENGGUNA ===== -->
    <div id="searchModal" class="modal-overlay">
        <div class="modal-content" style="max-width:600px">
            <button class="close-btn" onclick="closeModal('searchModal')">&times;</button>
            <h2 style="text-align:center;margin-bottom:20px;color:var(--primary)">?? Cari Pengguna</h2>
            <div style="display:flex;gap:10px;margin-bottom:20px">
                <input type="text" id="searchInput" placeholder="?? Ketik nama pengguna..."
                    style="flex:1;padding:14px 18px;border:2px solid var(--border-color);background:var(--bg-card);color:var(--text-primary);border-radius:12px;font-family:'Nunito',sans-serif;font-size:1rem"
                    oninput="filterSearchResults()" onkeypress="if(event.key==='Enter')filterSearchResults()">
                <button onclick="filterSearchResults()" class="btn-icon" style="padding:14px 20px">Cari</button>
            </div>
            <div id="searchResultsContainer" style="max-height:420px;overflow-y:auto"></div>
        </div>
    </div>

    <!-- ===== MODAL BARU: LIHAT PROFIL USER (READ-ONLY) ===== -->
    <div id="viewProfileModal" class="modal-overlay">
        <div class="modal-content" style="max-width:600px;padding:0" id="viewProfileModal">
            <button class="close-btn" onclick="closeModal('viewProfileModal')" style="z-index:10;color:#fff">&times;</button>
            <div class="profile-hero">
                <div id="vpAvatar" style="width:110px;height:110px;border-radius:50%;border:4px solid #fff;margin:0 auto 18px;background:#fff;color:var(--primary);display:flex;align-items:center;justify-content:center;font-size:2.8rem;font-weight:900;overflow:hidden">
                    <span id="vpAvatarText">A</span>
                </div>
                <div id="vpName" style="font-size:2rem;font-weight:900;margin-bottom:8px">-</div>
                <div id="vpTitle" style="font-size:1rem;opacity:.85;margin-bottom:5px">-</div>
                <div style="font-size:.85rem;opacity:.75"><span id="vpNim">NIM: -</span> | <span id="vpKelas">Kelas: -</span></div>
            </div>
            <div class="profile-body">
                <div style="margin-bottom:25px;padding-bottom:25px;border-bottom:2px solid var(--border-color)">
                    <div style="font-size:1.2rem;font-weight:700;color:var(--primary);margin-bottom:15px">?? Informasi</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                        <div><div style="font-size:.8rem;color:var(--text-secondary);font-weight:600;margin-bottom:4px">Tim & Jabatan</div><div id="vpTeamRole" style="font-weight:600;color:var(--text-primary)">-</div></div>
                        <div><div style="font-size:.8rem;color:var(--text-secondary);font-weight:600;margin-bottom:4px">Total Poin</div><div id="vpPoints" style="color:var(--success);font-weight:700;font-size:1.2rem">0</div></div>
                        <div><div style="font-size:.8rem;color:var(--text-secondary);font-weight:600;margin-bottom:4px">Peringkat</div><div id="vpRank" style="font-weight:600;color:var(--text-primary)">-</div></div>
                    </div>
                </div>
                <div>
                    <div style="font-size:1.2rem;font-weight:700;color:var(--primary);margin-bottom:15px">?? Riwayat Prestasi</div>
                    <div id="vpAchievements"><p style="color:var(--text-secondary);text-align:center;padding:20px">Belum ada prestasi</p></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== MODAL: LIST MINI GAME ===== -->
    <div id="gameListModal" class="modal-overlay">
        <div class="modal-content" style="max-width:650px">
            <button class="close-btn" onclick="closeModal('gameListModal')">&times;</button>
            <h2 style="text-align:center;margin-bottom:5px;color:var(--primary)">?? Mini Game</h2>
            <p style="text-align:center;color:var(--text-secondary);margin-bottom:10px">Pilih permainan untuk dimulai</p>
            <div class="game-list-grid">
                <div class="game-card" onclick="openWerewolfGame()">
                    <div class="game-card-icon">??</div>
                    <div class="game-card-name">Wharewolf</div>
                    <div class="game-card-desc">Game role-playing online multiplayer. Temukan siapa serigala di antara kalian melalui analisis bahasa & argumentasi!</div>
                    <div class="game-card-badge">612 Pemain  Multiplayer</div>
                </div>
                <!-- Slot game berikutnya -->
                <div class="game-card" style="opacity:.45;cursor:not-allowed" onclick="alert('Game ini belum tersedia. Segera hadir!')">
                    <div class="game-card-icon">??</div>
                    <div class="game-card-name">Word Puzzle</div>
                    <div class="game-card-desc">Tebak kata tersembunyi dari petunjuk yang diberikan. Segera hadir!</div>
                    <div class="game-card-badge" style="background:var(--gray)">Coming Soon</div>
                </div>
                <div class="game-card" style="opacity:.45;cursor:not-allowed" onclick="alert('Game ini belum tersedia. Segera hadir!')">
                    <div class="game-card-icon">??</div>
                    <div class="game-card-name">Quiz Sastra</div>
                    <div class="game-card-desc">Uji pengetahuan sastra Indonesiamu lewat kuis seru berhadiah poin!</div>
                    <div class="game-card-badge" style="background:var(--gray)">Coming Soon</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== WEREWOLF GAME OVERLAY (full screen) ===== -->
    <div id="wwOverlay" class="ww-overlay">
        <!-- LOBBY SCREEN -->
        <div id="wwLobbyScreen" class="ww-lobby">
            <div style="font-size:4rem;margin-bottom:10px">??</div>
            <h2>WHAREWOLF</h2>
            <p style="color:rgba(255,255,255,.65);margin-bottom:25px;max-width:450px">Game role-playing berbasis analisis bahasa. Temukan siapa serigala di antara kalian!</p>
            <div id="wwLobbyContent">
                <!-- Akan diisi JS: form buat/join room -->
            </div>
            <button onclick="closeWerewolfGame()" style="margin-top:20px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#fff;padding:10px 24px;border-radius:20px;cursor:pointer;font-family:'Nunito',sans-serif;font-weight:700">? Keluar</button>
        </div>

        <!-- WAITING ROOM -->
        <div id="wwWaitingScreen" style="display:none;color:#fff;padding:30px;text-align:center;width:100%">
            <div style="max-width:500px;margin:0 auto">
                <div style="font-size:3rem;margin-bottom:10px">?</div>
                <h3 style="font-size:1.5rem;margin-bottom:10px">Ruang Tunggu</h3>
                <div id="wwRoomCodeDisplay" class="ww-room-code">----</div>
                <p style="color:rgba(255,255,255,.6);font-size:.9rem;margin-bottom:20px">Bagikan kode ini ke teman-temanmu (612 pemain)</p>
                <div id="wwWaitingPlayers" class="ww-player-lobby-list"></div>
                <p id="wwWaitingStatus" style="color:rgba(255,255,255,.5);font-size:.85rem;margin:15px 0">Menunggu pemain bergabung...</p>
                <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
                    <button id="wwStartBtn" onclick="wwHostStartGame()" style="display:none;padding:14px 32px;background:linear-gradient(135deg,#4caf50,#2e7d32);color:#fff;border:none;border-radius:25px;cursor:pointer;font-weight:800;font-size:1rem;font-family:'Nunito',sans-serif">?? Mulai Permainan</button>
                    <button onclick="wwLeaveRoom()" style="padding:14px 24px;background:rgba(244,67,54,.3);border:1px solid rgba(244,67,54,.5);color:#ef9a9a;border-radius:25px;cursor:pointer;font-weight:700;font-family:'Nunito',sans-serif">?? Keluar Room</button>
                </div>
            </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="wwGameScreen" style="display:none;width:100%;height:100%;position:relative">
            <div class="ww-header">
                <div class="ww-title">
                    ?? WHAREWOLF
                    <span id="wwRoundBadge" style="background:rgba(255,255,255,.15);padding:4px 12px;border-radius:12px;font-size:.8rem">Ronde 1</span>
                </div>
                <div style="display:flex;align-items:center;gap:12px">
                    <span id="wwPhaseBadge" class="ww-phase-badge phase-night ww-phase-active">?? Malam</span>
                    <span id="wwTimerDisplay" style="color:#fff;font-weight:700;font-size:.9rem;background:rgba(255,255,255,.1);padding:5px 12px;border-radius:12px">--:--</span>
                    <button onclick="wwLeaveRoom()" style="background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#fff;padding:6px 14px;border-radius:14px;cursor:pointer;font-size:.8rem;font-family:'Nunito',sans-serif">? Keluar</button>
                </div>
            </div>
            <div class="ww-body">
                <!-- Sidebar kiri: pemain + peran -->
                <div class="ww-sidebar">
                    <div id="wwMyRoleCard" class="ww-role-card">
                        <div style="font-size:.7rem;color:rgba(255,255,255,.5);margin-bottom:4px">PERANMU</div>
                        <div id="wwMyRoleName" class="ww-role-name">-</div>
                        <div id="wwMyRoleDesc" class="ww-role-desc">-</div>
                    </div>
                    <div style="font-size:.75rem;color:rgba(255,255,255,.4);font-weight:700;margin-bottom:8px;text-transform:uppercase;letter-spacing:1px">Pemain (Hidup)</div>
                    <div id="wwPlayerList"></div>
                    <div style="font-size:.75rem;color:rgba(255,255,255,.4);font-weight:700;margin:10px 0 8px;text-transform:uppercase;letter-spacing:1px">Skormu</div>
                    <div id="wwMyScore" class="ww-score-card">0 poin</div>
                </div>
                <!-- Area utama: chat -->
                <div class="ww-main">
                    <div id="wwChatArea" class="ww-chat"></div>
                    <!-- Panel aksi berdasarkan fase & peran -->
                    <div id="wwActionPanel" class="ww-action-panel" style="display:none"></div>
                    <!-- Input chat -->
                    <div id="wwInputArea" class="ww-input-area">
                        <input type="text" id="wwChatInput" class="ww-input" placeholder="?? Ketik pesanmu..." onkeypress="if(event.key==='Enter')wwSendChat()" maxlength="300">
                        <button onclick="wwSendChat()" class="ww-send-btn">Kirim</button>
                    </div>
                </div>
            </div>
            <!-- Result overlay (muncul di akhir game) -->
            <div id="wwResultOverlay" style="display:none" class="ww-result-overlay">
                <div id="wwResultTitle" class="ww-result-title">-</div>
                <div id="wwResultBody" style="color:rgba(255,255,255,.75);margin-bottom:25px;max-width:500px;line-height:1.7"></div>
                <div id="wwFinalScores" style="margin-bottom:25px;width:100%;max-width:400px"></div>
                <button onclick="wwEndAndSavePoints()" style="padding:16px 40px;background:linear-gradient(135deg,#4caf50,#2e7d32);color:#fff;border:none;border-radius:25px;cursor:pointer;font-weight:800;font-size:1.1rem;font-family:'Nunito',sans-serif">? Simpan Poin & Keluar</button>
            </div>
        </div>
    </div>

    <div id="copiedToast" class="copied-toast">? Link berhasil disalin!</div>
    <script>
const SUPABASE_URL = 'https://cixnbqutgnzscmspuxft.supabase.co';
const SUPABASE_KEY = 'sb_publishable_B-6wORsbqmfoM3kp1mDUBA_SFIuHUak';
const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser=null,currentTheme=localStorage.getItem('gk_theme')||'light',statsChart=null,currentTimeFilter='weekly';
let uploadedImage=null,uploadedTeamLogo=null,uploadedProfilePhoto=null,currentViewingTeamId=null,chatRefreshInterval=null;
let allPosts=[],allTeams=[],allUsers=[],allCustomBadges=[],tempRegData={},selectedTeamId=null;
let currentBadgeDesign={id:null,name:'',emoji:'',photo:null,color:'linear-gradient(135deg,#ffd700,#ff8c00)'};

const ADMIN={nim:'00000',pass:'admin2026',name:'System Administrator',isAdmin:true,teams:[],team_roles:{},points:0,achievements:[],kelas:'SYSTEM'};

/* ============================================================
   LOAD DATA
============================================================ */
async function loadAllData(){
    try{
        const[teamsRes,usersRes,postsRes,badgesRes]=await Promise.all([
            db.from('teams').select('*').order('points',{ascending:false}),
            db.from('users').select('*').order('points',{ascending:false}),
            db.from('posts').select('*').order('timestamp',{ascending:false}).limit(50),
            db.from('custom_badges').select('*').order('created_at',{ascending:false})
        ]);
        allTeams=teamsRes.data||[];allUsers=usersRes.data||[];allPosts=postsRes.data||[];allCustomBadges=badgesRes.data||[];
    }catch(e){console.error('Load error:',e);allCustomBadges=JSON.parse(localStorage.getItem('gk_custom_badges')||'[]');}
}

/* ============================================================
   FYP ALGORITHM
============================================================ */
function applyFYP(posts){
    return[...posts].map(p=>{
        let score=0;
        const ageH=(Date.now()-p.timestamp)/3600000;
        if(ageH<1)score+=100;else if(ageH<6)score+=70;else if(ageH<24)score+=50;else if(ageH<72)score+=30;else if(ageH<168)score+=10;
        score+=(p.likes?.length||0)*8;score+=(p.comments?.length||0)*5;
        if(p.image)score+=15;
        if(currentUser&&p.author_team&&currentUser.teams?.includes(p.author_team))score+=25;
        score+=Math.random()*40;
        return{...p,_score:score};
    }).sort((a,b)=>b._score-a._score);
}

/* ============================================================
   INIT
============================================================ */
async function init(){
    showLoading();
    try{
        await loadAllData();
        const savedNim=localStorage.getItem('gk_nim'),savedAdmin=localStorage.getItem('gk_admin');
        if(savedAdmin==='true'){currentUser=ADMIN;}
        else if(savedNim){currentUser=allUsers.find(u=>u.nim===savedNim)||null;}
        applyTheme();updateNavState();updateHomepageUI();renderTables();renderFeed();initChart();
        // Cek URL param ?team=
        const params=new URLSearchParams(window.location.search);
        if(params.get('team')){const tid=parseInt(params.get('team'));if(tid)openTeamDetail(tid);}
    }catch(e){console.error('Init error:',e);}finally{hideLoading();}
}

/* ============================================================
   HELPERS
============================================================ */
function showLoading(){document.getElementById('loadingOverlay').style.display='flex';}
function hideLoading(){document.getElementById('loadingOverlay').style.display='none';}
function scrollToSection(id){document.getElementById(id)?.scrollIntoView({behavior:'smooth'});}
function openModal(id){document.getElementById(id).style.display='flex';}
function closeModal(id){
    document.getElementById(id).style.display='none';
    if(id==='teamDetailModal'&&chatRefreshInterval){clearInterval(chatRefreshInterval);chatRefreshInterval=null;}
}
function switchModal(a,b){closeModal(a);openModal(b);showStep('regStep1');}
function showStep(id){document.querySelectorAll('.form-step').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}
function toggleTheme(){currentTheme=currentTheme==='light'?'dark':'light';localStorage.setItem('gk_theme',currentTheme);applyTheme();}
function applyTheme(){
    document.documentElement.setAttribute('data-theme',currentTheme);
    document.getElementById('themeToggle').innerHTML=currentTheme==='light'?'??':'??';
    if(statsChart){statsChart.destroy();initChart();}
}
function checkLoginAction(){currentUser?openUserProfile():openModal('loginModal');}
function openLoginModal(){openModal('loginModal');}
function openRegisterModal(){openModal('registerModal');showStep('regStep1');}
function getTimeAgo(ts){
    const diff=Date.now()-ts,m=Math.floor(diff/60000),h=Math.floor(diff/3600000),d=Math.floor(diff/86400000);
    if(m<1)return'Baru saja';if(m<60)return m+' menit lalu';if(h<24)return h+' jam lalu';return d+' hari lalu';
}
function getBadgeIcon(b){
    const standard={
        members:'<span class="badge-icon" style="background:linear-gradient(135deg,#ff9800,#f57c00)" title="Anggota Terbanyak">??</span>',
        active:'<span class="badge-icon" style="background:linear-gradient(135deg,#4caf50,#388e3c)" title="Tim Teraktif">?</span>',
        creative:'<span class="badge-icon" style="background:linear-gradient(135deg,#9c27b0,#7b1fa2)" title="Tim Terkreatif">??</span>',
        achievement:'<span class="badge-icon" style="background:linear-gradient(135deg,#f44336,#d32f2f)" title="Tim Terprestasi">??</span>'
    };
    if(standard[b])return standard[b];
    if(b&&b.startsWith('custom_')){
        const custom=allCustomBadges.find(cb=>cb.badge_id===b);
        if(custom){
            const content=custom.photo?`<img src="${custom.photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`:(custom.emoji||'');
            const bg=custom.photo?'#f5f5f5':(custom.color||'linear-gradient(135deg,#ffd700,#ff8c00)');
            return`<span class="badge-icon" style="background:${bg}" title="${custom.name}">${content}</span>`;
        }
    }
    return'';
}

/* ============================================================
   AUTH
============================================================ */
async function processLogin(){
    const nim=document.getElementById('loginNim').value.trim(),pass=document.getElementById('loginPass').value;
    const alertDiv=document.getElementById('loginAlert');
    if(!nim||!pass){alertDiv.innerHTML='<div class="alert alert-danger">NIM dan password wajib diisi!</div>';return;}
    showLoading();
    try{
        if(nim===ADMIN.nim&&pass===ADMIN.pass){currentUser=ADMIN;localStorage.setItem('gk_admin','true');localStorage.removeItem('gk_nim');finishLogin(alertDiv);return;}
        const{data,error}=await db.from('users').select('*').eq('nim',nim).eq('pass',pass).single();
        if(error||!data){alertDiv.innerHTML='<div class="alert alert-danger">? NIM atau password salah!</div>';return;}
        currentUser=data;localStorage.setItem('gk_nim',nim);localStorage.removeItem('gk_admin');finishLogin(alertDiv);
    }catch(e){alertDiv.innerHTML=`<div class="alert alert-danger">?? Error: ${e.message}</div>`;}
    finally{hideLoading();}
}
function finishLogin(alertDiv){
    updateNavState();updateHomepageUI();renderFeed();closeModal('loginModal');
    document.getElementById('loginNim').value='';document.getElementById('loginPass').value='';
    if(alertDiv)alertDiv.innerHTML='';openUserProfile();
}
async function processLogout(){
    if(!confirm('Yakin ingin keluar?'))return;
    currentUser=null;localStorage.removeItem('gk_nim');localStorage.removeItem('gk_admin');
    updateNavState();updateHomepageUI();renderFeed();closeModal('userProfileModal');
}
function updateNavState(){
    if(currentUser){
        document.getElementById('navGuest').style.display='none';document.getElementById('navUser').style.display='block';
        document.getElementById('navUserName').innerText=currentUser.isAdmin?'?? ADMIN':currentUser.name.split(' ')[0];
        document.getElementById('userPillBtn').className=currentUser.isAdmin?'user-pill admin-pill':'user-pill';
    }else{document.getElementById('navGuest').style.display='flex';document.getElementById('navUser').style.display='none';}
}
function updateHomepageUI(){
    const create=document.getElementById('createPostSection'),prompt=document.getElementById('loginPromptSection');
    if(currentUser&&!currentUser.isAdmin){
        create.style.display='block';prompt.style.display='none';
        const av=document.getElementById('createAvatar');
        av.innerHTML=currentUser.profile_photo?`<img src="${currentUser.profile_photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`:currentUser.name.substring(0,2).toUpperCase();
    }else{create.style.display='none';prompt.style.display=currentUser?'none':'block';}
}

/* ============================================================
   REGISTER
============================================================ */
async function regNext1(){
    const nama=document.getElementById('regNama').value.trim(),nim=document.getElementById('regNim').value.trim();
    const kelas=document.getElementById('regKelas').value.trim(),alertDiv=document.getElementById('regAlert');
    if(!nama||!nim){alertDiv.innerHTML='<div class="alert alert-danger">Nama dan NIM wajib diisi!</div>';return;}
    if(nim===ADMIN.nim){alertDiv.innerHTML='<div class="alert alert-danger">NIM tidak valid!</div>';return;}
    showLoading();
    try{
        const{data}=await db.from('users').select('nim').eq('nim',nim).single();
        if(data){alertDiv.innerHTML='<div class="alert alert-danger">NIM sudah terdaftar!</div>';return;}
        tempRegData={nama,nim,kelas};alertDiv.innerHTML='';
        document.getElementById('regNamaPreview').innerText=nama;showStep('regStep2');
    }finally{hideLoading();}
}
function regNext2(){
    const pass=document.getElementById('regPass').value,passConfirm=document.getElementById('regPassConfirm').value;
    const robot=document.getElementById('robotCheck').checked,alertDiv=document.getElementById('regAlert2');
    if(!pass||pass.length<6){alertDiv.innerHTML='<div class="alert alert-danger">Password minimal 6 karakter!</div>';return;}
    if(pass!==passConfirm){alertDiv.innerHTML='<div class="alert alert-danger">Password tidak cocok!</div>';return;}
    if(!robot){alertDiv.innerHTML='<div class="alert alert-danger">Centang verifikasi robot dulu!</div>';return;}
    tempRegData.pass=pass;alertDiv.innerHTML='';
    document.getElementById('regNamaPreview').innerText=tempRegData.nama;showStep('regStep3');
}
async function goToJoinList(){
    showStep('panelJoinTeam');
    const container=document.getElementById('joinListContainer');
    container.innerHTML='<p style="text-align:center;padding:20px;color:var(--text-secondary)">? Memuat daftar tim...</p>';
    const{data}=await db.from('teams').select('*').order('points',{ascending:false});
    container.innerHTML='';
    (data||[]).forEach(t=>{
        const members=allUsers.filter(u=>u.teams?.includes(t.name));
        container.innerHTML+=`<div style="padding:15px;border-bottom:1px solid var(--border-color);cursor:pointer;border-radius:8px;color:var(--text-primary);transition:.2s"
            onmouseover="this.style.background='var(--secondary)'" onmouseout="this.style.background='transparent'"
            onclick="selectTeam(${t.id},this)">
            <div style="font-weight:700">${t.name}</div>
            <div style="font-size:.85rem;color:var(--text-secondary);margin-top:3px">${t.focus}  ${t.points} poin  ${members.length} anggota</div>
        </div>`;
    });
    if(!data?.length)container.innerHTML='<p style="text-align:center;padding:20px;color:var(--text-secondary)">Belum ada tim tersedia</p>';
}
function selectTeam(teamId,el){
    selectedTeamId=teamId;
    document.querySelectorAll('#joinListContainer div').forEach(d=>{d.style.background='transparent';d.style.border='none';});
    el.style.background='var(--secondary)';el.style.border='2px solid var(--primary)';el.style.borderRadius='8px';
}
async function finalJoinTeam(){
    if(!selectedTeamId){alert('Pilih tim dulu!');return;}
    showLoading();
    try{
        const{data:team}=await db.from('teams').select('*').eq('id',selectedTeamId).single();
        const members=allUsers.filter(u=>u.teams?.includes(team.name));
        const hasLeader=members.some(m=>m.team_roles?.[team.name]==='Ketua');
        const role=hasLeader?'Anggota':'Ketua';
        const{error}=await db.from('users').insert({
            nim:tempRegData.nim,pass:tempRegData.pass,name:tempRegData.nama,kelas:tempRegData.kelas,
            teams:[team.name],team_roles:{[team.name]:role},points:0,achievements:[],point_logs:[],profile_photo:null,join_date:Date.now()
        });
        if(error)throw error;
        alert(`? Registrasi berhasil!\nAnda bergabung sebagai ${role} di tim ${team.name}.\nSilakan Login.`);
        closeModal('registerModal');tempRegData={};selectedTeamId=null;await loadAllData();renderTables();
    }catch(e){alert('? Gagal: '+e.message);}finally{hideLoading();}
}
async function finalCreateTeam(){
    const name=document.getElementById('newTeamName').value.trim(),focus=document.getElementById('newTeamFocus').value.trim();
    const visi=document.getElementById('newTeamVisi').value.trim(),dev=document.getElementById('newTeamDev').value.trim();
    if(!name||!focus){alert('Nama dan fokus wajib diisi!');return;}
    showLoading();
    try{
        const{data:existing}=await db.from('teams').select('id').ilike('name',name).single();
        if(existing){alert('Nama tim sudah digunakan!');return;}
        const{error:teamErr}=await db.from('teams').insert({name,focus,visi,dev,logo:null,logo_text:name.substring(0,2).toUpperCase(),points:100,activities:[],badges:[],available_badges:[]});
        if(teamErr)throw teamErr;
        const{error:userErr}=await db.from('users').insert({
            nim:tempRegData.nim,pass:tempRegData.pass,name:tempRegData.nama,kelas:tempRegData.kelas,
            teams:[name],team_roles:{[name]:'Ketua'},points:100,achievements:[],point_logs:[],profile_photo:null,join_date:Date.now()
        });
        if(userErr)throw userErr;
        alert(`?? Tim "${name}" berhasil dibuat!\nAnda terdaftar sebagai Ketua.\nSilakan Login.`);
        closeModal('registerModal');tempRegData={};await loadAllData();renderTables();
    }catch(e){alert('? Gagal: '+e.message);}finally{hideLoading();}
}

/* ============================================================
   LEADERBOARD TABLE  dengan baris klikable
============================================================ */
function renderTables(){
    const sorted=[...allTeams].sort((a,b)=>b.points-a.points);
    const teamBody=document.getElementById('teamTableBody');teamBody.innerHTML='';
    sorted.forEach((t,i)=>{
        const medal=i===0?'??':i===1?'??':i===2?'??':(i+1);
        const badges=(t.badges||[]).map(b=>getBadgeIcon(b)).join('')||'<span style="color:var(--text-secondary)">-</span>';
        const tr=document.createElement('tr');
        tr.className='clickable-row';
        tr.title='Klik untuk melihat detail tim';
        tr.innerHTML=`<td><b>${medal}</b></td><td><b>${t.name}</b></td><td style="color:var(--text-secondary)">${t.focus}</td><td><div style="display:flex;flex-wrap:wrap;gap:3px">${badges}</div></td><td><b style="color:var(--success)">${t.points}</b></td>`;
        tr.onclick=()=>openTeamDetail(t.id);
        teamBody.appendChild(tr);
    });

    const indBody=document.getElementById('individuTableBody');indBody.innerHTML='';
    allUsers.filter(u=>!u.is_admin).sort((a,b)=>b.points-a.points).forEach(u=>{
        const teams=(u.teams||[]).join(', ')||'-';
        const roles=(u.teams||[]).map(t=>`${t} (${u.team_roles?.[t]||'Anggota'})`).join(', ')||'-';
        const tr=document.createElement('tr');
        tr.className='clickable-row';
        tr.title='Klik untuk melihat profil';
        tr.innerHTML=`<td>${u.name}</td><td style="color:var(--text-secondary)">${teams}</td><td style="font-size:.85rem;color:var(--text-secondary)">${roles}</td><td><b style="color:var(--success)">${u.points}</b></td>`;
        tr.onclick=()=>openViewProfile(u.nim);
        indBody.appendChild(tr);
    });
}

/* ============================================================
   CHART  FIX: Gunakan data point_logs real dari database
   Kumpulkan semua point_logs dari semua users,
   group per hari/bulan, lalu tampilkan sebagai grafik akumulasi
============================================================ */
function initChart(){
    const ctx=document.getElementById('statsChart');
    if(statsChart)statsChart.destroy();
    const isDark=currentTheme==='dark';
    const gridColor=isDark?'rgba(255,255,255,0.08)':'rgba(123,45,139,0.07)';
    const textColor=isDark?'#e9ecef':'#2d1b35';
    const data=getChartData(currentTimeFilter);
    statsChart=new Chart(ctx,{
        type:'line',
        data:{
            labels:data.labels,
            datasets:[{
                label:'Total Poin Semua Tim',
                data:data.values,
                borderColor:'#7B2D8B',
                backgroundColor:'rgba(123,45,139,0.08)',
                tension:0.4,fill:true,
                pointRadius:5,pointBackgroundColor:'#E8395A',
                pointBorderColor:'#7B2D8B',pointBorderWidth:2
            }]
        },
        options:{
            responsive:true,maintainAspectRatio:false,
            plugins:{legend:{display:true,labels:{color:textColor,font:{size:13,family:'Nunito',weight:'700'}}}},
            scales:{
                y:{beginAtZero:true,ticks:{color:textColor,callback:v=>v+' poin',font:{family:'Nunito'}},grid:{color:gridColor}},
                x:{ticks:{color:textColor,font:{family:'Nunito'}},grid:{color:gridColor}}
            }
        }
    });
}

function getChartData(filter){
    /* Kumpulkan SEMUA point_logs dari seluruh user */
    const allLogs=[];
    allUsers.forEach(u=>{
        (u.point_logs||[]).forEach(log=>{
            if(log.timestamp)allLogs.push({ts:log.timestamp,points:log.points||0});
        });
    });

    const now=Date.now();
    const labels=[],values=[];

    if(filter==='weekly'){
        /* 7 hari terakhir */
        const dayNames=['Min','Sen','Sel','Rab','Kam','Jum','Sab'];
        for(let i=6;i>=0;i--){
            const d=new Date(now);d.setDate(d.getDate()-i);
            const dayStart=new Date(d.getFullYear(),d.getMonth(),d.getDate()).getTime();
            const dayEnd=dayStart+86400000;
            labels.push(dayNames[d.getDay()]+' '+d.getDate());
            /* Hitung poin yang masuk di hari ini (kumulatif sampai akhir hari ini) */
            const cumulative=allLogs.filter(l=>l.ts<=dayEnd).reduce((s,l)=>s+l.points,0);
            values.push(cumulative);
        }
    }else{
        /* 12 bulan terakhir */
        const monthNames=['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'];
        for(let i=11;i>=0;i--){
            const d=new Date(now);d.setMonth(d.getMonth()-i);
            const monthEnd=new Date(d.getFullYear(),d.getMonth()+1,0,23,59,59,999).getTime();
            labels.push(monthNames[d.getMonth()]+' '+d.getFullYear().toString().slice(2));
            const cumulative=allLogs.filter(l=>l.ts<=monthEnd).reduce((s,l)=>s+l.points,0);
            values.push(cumulative);
        }
    }
    return{labels,values};
}

function changeTimeFilter(filter,event){
    currentTimeFilter=filter;
    document.querySelectorAll('.time-filter-btn').forEach(b=>b.classList.remove('active'));
    event.target.classList.add('active');initChart();
}

/* ============================================================
   FEED  Foto profil + klik ke profil poster
============================================================ */
function previewImage(event){
    const file=event.target.files[0];if(!file)return;
    if(!file.type.startsWith('image/')){alert('File harus berupa gambar!');return;}
    if(file.size>5*1024*1024){alert('Maksimal 5MB!');return;}
    const reader=new FileReader();
    reader.onload=e=>{uploadedImage=e.target.result;document.getElementById('imgPreview').src=uploadedImage;document.getElementById('imgPreviewBox').style.display='block';};
    reader.readAsDataURL(file);
}
function removeImage(){uploadedImage=null;document.getElementById('imgPreview').src='';document.getElementById('imgPreviewBox').style.display='none';document.getElementById('fileInput').value='';}

async function createPost(){
    if(!currentUser||currentUser.isAdmin){alert('Silakan login!');return;}
    const content=document.getElementById('postInput').value.trim();
    if(!content&&!uploadedImage){alert('Postingan tidak boleh kosong!');return;}
    showLoading();
    try{
        const{error}=await db.from('posts').insert({
            author_nim:currentUser.nim,author_name:currentUser.name,
            author_team:currentUser.teams?.[0]||'Tanpa Tim',
            content,image:uploadedImage,likes:[],comments:[],timestamp:Date.now()
        });
        if(error)throw error;
        document.getElementById('postInput').value='';removeImage();await loadAllData();renderFeed();alert('? Postingan berhasil dibuat!');
    }catch(e){alert('? Gagal posting: '+e.message);}finally{hideLoading();}
}

function renderFeed(){
    const container=document.getElementById('feedContainer');
    if(!allPosts.length){
        container.innerHTML=`<div style="text-align:center;padding:60px;color:var(--text-secondary)"><p style="font-size:4rem">??</p><p style="font-size:1.2rem;margin-top:10px">Belum ada postingan</p><p style="font-size:.9rem;margin-top:5px">Jadilah yang pertama berbagi karya!</p></div>`;
        return;
    }
    container.innerHTML='';applyFYP([...allPosts]).forEach(p=>container.appendChild(createPostCard(p)));
}

function createPostCard(post){
    const div=document.createElement('div');div.className='post-card';div.id='post_'+post.id;
    const isLiked=currentUser&&post.likes?.includes(currentUser.nim);
    const canDelete=currentUser?.isAdmin||currentUser?.nim===post.author_nim;

    /* Cari data user poster untuk foto profil */
    const posterUser=allUsers.find(u=>u.nim===post.author_nim);
    let avatarContent='';
    if(posterUser?.profile_photo){
        avatarContent=`<img src="${posterUser.profile_photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
    }else{
        avatarContent=`<span style="color:#fff;font-weight:700;font-size:1.1rem">${post.author_name.substring(0,2).toUpperCase()}</span>`;
    }

    /* Avatar klikable untuk membuka profil poster */
    const avatarClickHandler=posterUser?`onclick="openViewProfile('${post.author_nim}')" title="Lihat profil ${post.author_name}"`:'';

    div.innerHTML=`
        <div class="post-header">
            <div class="post-avatar-link" ${avatarClickHandler}
                style="width:48px;height:48px;background:linear-gradient(135deg,#7B2D8B,#E8395A);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;${posterUser?'cursor:pointer;':''}">
                ${avatarContent}
            </div>
            <div class="post-user-info" style="cursor:${posterUser?'pointer':'default'}" ${posterUser?`onclick="openViewProfile('${post.author_nim}')"`:''}>
                <div class="post-user-name">${post.author_name}</div>
                <div class="post-user-meta">?? ${post.author_team}  ?? ${getTimeAgo(post.timestamp)}</div>
            </div>
            ${canDelete?`<button class="post-delete-btn" onclick="deletePost(${post.id})">??? Hapus</button>`:''}
        </div>
        ${post.content?`<div class="post-content">${post.content}</div>`:''}
        ${post.image?`<img src="${post.image}" class="post-image" onclick="viewImage('${post.image}')" alt="Post Image">`:''}
        <div class="post-actions">
            <button class="post-action-btn ${isLiked?'liked':''}" onclick="toggleLike(${post.id})">${isLiked?'??':'??'} <span id="likeCount_${post.id}">${post.likes?.length||0}</span> Suka</button>
            <button class="post-action-btn" onclick="toggleComments(${post.id})">?? <span id="commentCount_${post.id}">${post.comments?.length||0}</span> Komentar</button>
        </div>
        <div id="comments_${post.id}" style="display:none;margin-top:18px;padding-top:18px;border-top:2px solid var(--border-color)">
            <div id="commentsList_${post.id}"></div>
            ${currentUser&&!currentUser.isAdmin?`
                <div style="display:flex;gap:10px;margin-top:15px">
                    <input type="text" id="commentInput_${post.id}" placeholder="?? Tulis komentar..." style="flex:1;padding:10px 18px;border:2px solid var(--border-color);background:var(--bg-main);color:var(--text-primary);border-radius:25px;font-size:.95rem;font-family:'Nunito',sans-serif" onkeypress="if(event.key==='Enter')addComment(${post.id})">
                    <button onclick="addComment(${post.id})" style="padding:10px 22px;background:linear-gradient(135deg,#7B2D8B,#E8395A);color:#fff;border:none;border-radius:25px;cursor:pointer;font-weight:700;font-family:'Nunito',sans-serif">Kirim</button>
                </div>`:`<p style="text-align:center;color:var(--text-secondary);padding:10px;font-size:.9rem">Login untuk berkomentar</p>`}
        </div>`;
    return div;
}

function viewImage(src){
    const o=document.createElement('div');
    o.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(45,27,61,.95);z-index:9999;display:flex;align-items:center;justify-content:center;cursor:zoom-out;padding:20px;backdrop-filter:blur(8px)';
    o.onclick=()=>document.body.removeChild(o);
    o.innerHTML=`<img src="${src}" style="max-width:95%;max-height:92vh;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.5)">`;
    document.body.appendChild(o);
}

async function toggleLike(postId){
    if(!currentUser||currentUser.isAdmin){alert('Login untuk menyukai!');return;}
    const post=allPosts.find(p=>p.id===postId);if(!post)return;
    let likes=[...(post.likes||[])];const idx=likes.indexOf(currentUser.nim);
    if(idx>-1)likes.splice(idx,1);else likes.push(currentUser.nim);
    await db.from('posts').update({likes}).eq('id',postId);post.likes=likes;
    const isLiked=likes.includes(currentUser.nim);
    const btn=document.querySelector(`#post_${postId} .post-action-btn`);
    btn.className='post-action-btn'+(isLiked?' liked':'');
    btn.innerHTML=`${isLiked?'??':'??'} <span id="likeCount_${postId}">${likes.length}</span> Suka`;
}
function toggleComments(postId){
    const s=document.getElementById('comments_'+postId);
    if(s.style.display==='none'){s.style.display='block';renderComments(postId);}else s.style.display='none';
}
function renderComments(postId){
    const post=allPosts.find(p=>p.id===postId);
    const container=document.getElementById('commentsList_'+postId);container.innerHTML='';
    if(!post.comments?.length){container.innerHTML='<p style="text-align:center;color:var(--text-secondary);padding:15px;font-size:.9rem">Belum ada komentar. Jadilah yang pertama!</p>';return;}
    post.comments.forEach((c,ci)=>{
        const av=c.authorName.substring(0,2).toUpperCase();
        const div=document.createElement('div');div.style.cssText='background:var(--bg-main);padding:14px;border-radius:12px;margin-bottom:10px';
        div.innerHTML=`<div style="display:flex;gap:10px">
            <div style="width:36px;height:36px;background:linear-gradient(135deg,#7B2D8B,#E8395A);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8rem;flex-shrink:0">${av}</div>
            <div style="flex:1">
                <div style="font-weight:700;color:var(--text-primary);font-size:.95rem">${c.authorName}</div>
                <div style="color:var(--text-primary);line-height:1.6;margin-top:3px">${c.text}</div>
                <div style="display:flex;gap:15px;margin-top:6px;align-items:center">
                    <span style="font-size:.75rem;color:var(--text-secondary)">${getTimeAgo(c.timestamp)}</span>
                    ${currentUser&&!currentUser.isAdmin?`<button onclick="toggleReply(${postId},${ci})" style="background:none;border:none;color:var(--primary);cursor:pointer;font-size:.8rem;font-weight:700;font-family:'Nunito',sans-serif">?? Balas</button>`:''}
                </div>
                <div id="replyForm_${postId}_${ci}" style="display:none;margin-top:8px">
                    <div style="display:flex;gap:8px">
                        <input type="text" id="replyInput_${postId}_${ci}" placeholder="Balas komentar..." style="flex:1;padding:8px 14px;border:2px solid var(--border-color);background:var(--bg-card);color:var(--text-primary);border-radius:20px;font-size:.9rem;font-family:'Nunito',sans-serif" onkeypress="if(event.key==='Enter')addReply(${postId},${ci})">
                        <button onclick="addReply(${postId},${ci})" style="padding:8px 16px;background:linear-gradient(135deg,#7B2D8B,#E8395A);color:#fff;border:none;border-radius:20px;cursor:pointer;font-weight:700;font-size:.85rem;font-family:'Nunito',sans-serif">Kirim</button>
                    </div>
                </div>
                <div id="replies_${postId}_${ci}" style="margin-top:8px;padding-left:12px;border-left:3px solid var(--border-color)"></div>
            </div>
        </div>`;
        container.appendChild(div);if(c.replies?.length)renderReplies(postId,ci,c.replies);
    });
}
function toggleReply(postId,ci){const f=document.getElementById(`replyForm_${postId}_${ci}`);f.style.display=f.style.display==='none'?'block':'none';}
function renderReplies(postId,ci,replies){
    const c=document.getElementById(`replies_${postId}_${ci}`);if(!c)return;c.innerHTML='';
    replies.forEach(r=>{
        const av=r.authorName.substring(0,2).toUpperCase();
        c.innerHTML+=`<div style="display:flex;gap:8px;margin-bottom:8px;background:var(--bg-card);padding:10px;border-radius:8px">
            <div style="width:28px;height:28px;background:linear-gradient(135deg,#7B2D8B,#E8395A);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.7rem;flex-shrink:0">${av}</div>
            <div><div style="font-weight:700;color:var(--text-primary);font-size:.85rem">${r.authorName}</div><div style="color:var(--text-primary);font-size:.9rem">${r.text}</div><span style="font-size:.7rem;color:var(--text-secondary)">${getTimeAgo(r.timestamp)}</span></div>
        </div>`;
    });
}
async function addComment(postId){
    if(!currentUser||currentUser.isAdmin)return;
    const input=document.getElementById('commentInput_'+postId),text=input.value.trim();if(!text)return;
    const post=allPosts.find(p=>p.id===postId),comments=[...(post.comments||[])];
    comments.push({authorNim:currentUser.nim,authorName:currentUser.name,text,timestamp:Date.now(),replies:[]});
    await db.from('posts').update({comments}).eq('id',postId);post.comments=comments;input.value='';
    renderComments(postId);document.getElementById('commentCount_'+postId).innerText=comments.length;
}
async function addReply(postId,ci){
    if(!currentUser||currentUser.isAdmin)return;
    const input=document.getElementById(`replyInput_${postId}_${ci}`),text=input.value.trim();if(!text)return;
    const post=allPosts.find(p=>p.id===postId),comments=[...(post.comments||[])];
    if(!comments[ci].replies)comments[ci].replies=[];
    comments[ci].replies.push({authorNim:currentUser.nim,authorName:currentUser.name,text,timestamp:Date.now()});
    await db.from('posts').update({comments}).eq('id',postId);post.comments=comments;input.value='';renderComments(postId);
}
async function deletePost(postId){
    if(!confirm('Hapus postingan ini?'))return;showLoading();
    await db.from('posts').delete().eq('id',postId);allPosts=allPosts.filter(p=>p.id!==postId);renderFeed();hideLoading();
}

/* ============================================================
   FITUR BARU: SEARCH MODAL  Cari Pengguna
============================================================ */
function openSearchModal(){
    openModal('searchModal');
    document.getElementById('searchInput').value='';
    renderSearchResults(allUsers.filter(u=>!u.is_admin));
}
function filterSearchResults(){
    const q=document.getElementById('searchInput').value.trim().toLowerCase();
    if(!q){renderSearchResults(allUsers.filter(u=>!u.is_admin));return;}
    const filtered=allUsers.filter(u=>!u.is_admin&&u.name.toLowerCase().includes(q));
    renderSearchResults(filtered);
}
function renderSearchResults(users){
    const c=document.getElementById('searchResultsContainer');
    if(!users.length){
        c.innerHTML='<div style="text-align:center;padding:40px;color:var(--text-secondary)"><p style="font-size:2.5rem">??</p><p style="margin-top:10px">Pengguna tidak ditemukan</p></div>';
        return;
    }
    c.innerHTML='';
    users.forEach(u=>{
        const sorted=allUsers.filter(x=>!x.is_admin).sort((a,b)=>b.points-a.points);
        const rank=sorted.findIndex(x=>x.nim===u.nim)+1;
        const teams=(u.teams||[]).join(', ')||'Belum bergabung tim';
        let avContent='';
        if(u.profile_photo){
            avContent=`<img src="${u.profile_photo}" style="width:100%;height:100%;object-fit:cover">`;
        }else{
            avContent=`<span>${u.name.substring(0,2).toUpperCase()}</span>`;
        }
        const item=document.createElement('div');item.className='search-user-item';
        item.onclick=()=>{closeModal('searchModal');openViewProfile(u.nim);};
        item.innerHTML=`
            <div class="search-avatar-sm">${avContent}</div>
            <div style="flex:1">
                <div style="font-weight:800;color:var(--text-primary)">${u.name}</div>
                <div style="font-size:.85rem;color:var(--text-secondary);margin-top:2px">?? ${teams}</div>
                <div style="font-size:.8rem;color:var(--text-secondary)">NIM: ${u.nim} | Kelas: ${u.kelas||'-'}</div>
            </div>
            <div style="text-align:right">
                <div style="font-weight:700;color:var(--success);font-size:1.1rem">${u.points} poin</div>
                <div style="font-size:.8rem;color:var(--text-secondary)">Rank #${rank}</div>
            </div>`;
        c.appendChild(item);
    });
}

/* ============================================================
   FITUR BARU: VIEW PROFILE  Lihat profil orang lain (read-only)
============================================================ */
function openViewProfile(nim){
    const u=allUsers.find(x=>x.nim===nim);
    if(!u){alert('Profil tidak ditemukan');return;}

    /* Jika ini profil sendiri dan sudah login, buka profil sendiri */
    if(currentUser&&!currentUser.isAdmin&&currentUser.nim===nim){
        closeModal('searchModal');openUserProfile();return;
    }

    const sorted=allUsers.filter(x=>!x.is_admin).sort((a,b)=>b.points-a.points);
    const rank=sorted.findIndex(x=>x.nim===nim)+1;
    const teams=[...new Set(u.teams||[])];
    const rolesText=teams.map(t=>`${t} - ${u.team_roles?.[t]||'Anggota'}`).join('<br>')||'Belum bergabung tim';

    /* Avatar */
    const vpAvatar=document.getElementById('vpAvatar');
    if(u.profile_photo){
        vpAvatar.innerHTML=`<img src="${u.profile_photo}" style="width:100%;height:100%;object-fit:cover">`;
    }else{
        vpAvatar.innerHTML=`<span id="vpAvatarText">${u.name.substring(0,2).toUpperCase()}</span>`;
    }

    document.getElementById('vpName').innerText=u.name;
    document.getElementById('vpNim').innerText='NIM: '+u.nim;
    document.getElementById('vpKelas').innerText='Kelas: '+(u.kelas||'-');
    document.getElementById('vpTitle').innerHTML=rolesText;
    document.getElementById('vpTeamRole').innerHTML=rolesText;
    document.getElementById('vpPoints').innerText=u.points;
    document.getElementById('vpRank').innerText=`#${rank} dari ${sorted.length} peserta`;

    /* Prestasi */
    const achDiv=document.getElementById('vpAchievements');
    if(!u.achievements?.length){
        achDiv.innerHTML='<p style="color:var(--text-secondary);text-align:center;padding:20px">Belum ada prestasi yang dicatat</p>';
    }else{
        achDiv.innerHTML='';
        [...u.achievements].reverse().forEach(a=>{
            const cls=a.type==='latihan'?'point-latihan':a.type==='karya'?'point-karya':'point-lomba';
            const pts=a.type==='latihan'?'+30':a.type==='karya'?'+50':'+70';
            achDiv.innerHTML+=`<div style="background:var(--bg-main);padding:14px;border-radius:10px;margin-bottom:10px;border-left:4px solid var(--success)">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;flex-wrap:wrap;gap:8px">
                    <span class="point-badge ${cls}">${a.type} ${pts} poin</span>
                    <span style="font-size:.8rem;color:var(--text-secondary)">${new Date(a.timestamp).toLocaleDateString('id-ID')}</span>
                </div>
                <div style="font-size:.9rem;color:var(--text-primary)">${a.description}</div>
            </div>`;
        });
    }
    openModal('viewProfileModal');
}

/* ============================================================
   TEAM LIST & TEAM DETAIL
============================================================ */
function openTeamListModal(){
    openModal('teamListModal');const grid=document.getElementById('allTeamsGrid');grid.innerHTML='';
    [...allTeams].sort((a,b)=>b.points-a.points).forEach((t,i)=>{
        const members=allUsers.filter(u=>u.teams?.includes(t.name));
        const badges=(t.badges||[]).map(b=>getBadgeIcon(b)).join('')||'';
        const logo=t.logo?`<img src="${t.logo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`:t.logo_text;
        grid.innerHTML+=`<div class="team-card-coc" onclick="openTeamDetail(${t.id})">
            <div style="background:linear-gradient(135deg,rgba(123,45,139,.2),rgba(232,57,90,.08));padding:25px 20px 15px;border-bottom:2px solid rgba(123,45,139,.3);text-align:center;position:relative">
                <div style="position:absolute;top:12px;right:12px;background:linear-gradient(135deg,#7B2D8B,#E8395A);color:#fff;padding:4px 10px;border-radius:12px;font-size:.75rem;font-weight:700">#${i+1}</div>
                <div class="team-logo-coc">${logo}</div>
            </div>
            <div style="padding:20px;color:#fff">
                <div style="font-size:1.3rem;font-weight:900;color:#E8C4F0;text-align:center;margin-bottom:6px">${t.name}</div>
                <div style="text-align:center;color:#aaa;font-size:.9rem;margin-bottom:12px">${t.focus}</div>
                <div style="display:flex;gap:5px;justify-content:center;min-height:40px;flex-wrap:wrap;margin-bottom:12px">${badges}</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                    <div style="background:rgba(255,255,255,.06);padding:10px;border-radius:10px;text-align:center"><div style="font-size:.7rem;color:#888;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">POIN</div><div style="font-size:1.1rem;font-weight:700;color:#F5A623">${t.points}</div></div>
                    <div style="background:rgba(255,255,255,.06);padding:10px;border-radius:10px;text-align:center"><div style="font-size:.7rem;color:#888;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">ANGGOTA</div><div style="font-size:1.1rem;font-weight:700;color:#4A90D9">${members.length}</div></div>
                </div>
            </div>
        </div>`;
    });
    if(!allTeams.length)grid.innerHTML='<p style="text-align:center;color:var(--text-secondary);padding:40px;grid-column:1/-1">Belum ada tim</p>';
}

async function openTeamDetail(teamId){
    const team=allTeams.find(t=>t.id===teamId);if(!team)return;
    currentViewingTeamId=teamId;
    const sorted=[...allTeams].sort((a,b)=>b.points-a.points);
    const rank=sorted.findIndex(t=>t.id===teamId)+1;
    const members=allUsers.filter(u=>u.teams?.includes(team.name));
    const isLeader=currentUser&&!currentUser.isAdmin&&members.find(u=>u.nim===currentUser.nim&&u.team_roles?.[team.name]==='Ketua');
    const logoEl=document.getElementById('detailLogoContainer');
    logoEl.innerHTML=team.logo?`<img src="${team.logo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`:`<span>${team.logo_text}</span>`;
    if(isLeader){
        logoEl.style.cssText='width:120px;height:120px;background:var(--primary);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:3rem;margin:0 auto 15px;font-weight:700;overflow:hidden;cursor:pointer;border:4px solid var(--gold);box-shadow:0 0 20px rgba(255,215,0,.35)';
        logoEl.title='?? Klik untuk pengaturan tim';logoEl.onclick=openTeamSettings;
    }else{
        logoEl.style.cssText='width:120px;height:120px;background:var(--primary);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:3rem;margin:0 auto 15px;font-weight:700;overflow:hidden';
        logoEl.onclick=null;
    }
    document.getElementById('detailName').innerText=team.name;document.getElementById('detailFocus').innerText=team.focus;
    document.getElementById('detailRank').innerText=rank;document.getElementById('detailPoints').innerText=team.points;
    document.getElementById('detailVisi').innerText=team.visi||'Belum ada visi misi.';document.getElementById('detailDev').innerText=team.dev||'-';
    document.getElementById('detailMemberCount').innerText=`${members.length} anggota`;
    document.getElementById('detailBadges').innerHTML=(team.badges||[]).map(b=>getBadgeIcon(b)).join('')||'';
    document.getElementById('chatTeamName').innerText=team.name;
    document.getElementById('manageTab').style.display=isLeader?'block':'none';
    renderTeamMembers(team.name);renderActivityLog(team);updateJoinButton(team);
    ['tabInfo','tabMembers','tabActivities','tabChat','tabManage'].forEach(id=>document.getElementById(id).style.display='none');
    document.getElementById('tabInfo').style.display='block';
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-btn')[0].classList.add('active');
    closeModal('teamListModal');openModal('teamDetailModal');
}
function updateJoinButton(team){
    const isMember=currentUser&&!currentUser.isAdmin&&currentUser.teams?.includes(team.name);
    document.getElementById('joinBtnText').innerText=isMember?'?? Buka Chat':'?? Bergabung';
    document.getElementById('joinOrChatBtn').style.background=isMember?'var(--primary)':'var(--success)';
    document.getElementById('leaveTeamBtn').style.display=isMember?'flex':'none';
}
async function handleJoinOrChat(){
    if(!currentUser||currentUser.isAdmin){alert('Login terlebih dahulu!');return;}
    const team=allTeams.find(t=>t.id===currentViewingTeamId);if(!team)return;
    if(currentUser.teams?.includes(team.name)){switchTeamTab('chat');return;}
    if(!confirm(`Bergabung ke tim "${team.name}"?`))return;
    showLoading();
    try{
        const members=allUsers.filter(u=>u.teams?.includes(team.name));
        const hasLeader=members.some(m=>m.team_roles?.[team.name]==='Ketua');
        const role=hasLeader?'Anggota':'Ketua';
        const newTeams=[...(currentUser.teams||[]),team.name];
        const newRoles={...(currentUser.team_roles||{}),[team.name]:role};
        await db.from('users').update({teams:newTeams,team_roles:newRoles}).eq('nim',currentUser.nim);
        currentUser.teams=newTeams;currentUser.team_roles=newRoles;
        const u=allUsers.find(u=>u.nim===currentUser.nim);if(u){u.teams=newTeams;u.team_roles=newRoles;}
        alert(`? Berhasil bergabung sebagai ${role}!`);openTeamDetail(team.id);renderTables();
    }catch(e){alert('? Gagal: '+e.message);}finally{hideLoading();}
}
async function leaveTeam(){
    if(!currentUser)return;const team=allTeams.find(t=>t.id===currentViewingTeamId);if(!team)return;
    const isLeader=currentUser.team_roles?.[team.name]==='Ketua';
    const msg=isLeader?`?? KELUAR dari "${team.name}"?\nAnda adalah KETUA tim ini!`:`Keluar dari tim "${team.name}"?`;
    if(!confirm(msg))return;showLoading();
    try{
        const newTeams=currentUser.teams.filter(t=>t!==team.name),newRoles={...currentUser.team_roles};
        delete newRoles[team.name];
        await db.from('users').update({teams:newTeams,team_roles:newRoles}).eq('nim',currentUser.nim);
        currentUser.teams=newTeams;currentUser.team_roles=newRoles;
        alert(`? Anda telah keluar dari ${team.name}`);closeModal('teamDetailModal');await loadAllData();renderTables();
    }catch(e){alert('? Gagal: '+e.message);}finally{hideLoading();}
}
function renderTeamMembers(teamName){
    const c=document.getElementById('membersList');c.innerHTML='';
    const members=allUsers.filter(u=>u.teams?.includes(teamName));
    if(!members.length){c.innerHTML='<p style="color:var(--text-secondary);padding:10px">Belum ada anggota</p>';return;}
    members.forEach(m=>{
        const role=m.team_roles?.[teamName]||'Anggota';
        const isSelf=currentUser&&m.nim===currentUser.nim?' <span style="color:var(--primary);font-size:.85rem">(Anda)</span>':'';
        c.innerHTML+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px dotted var(--border-color)">
            <div><span style="color:var(--text-primary);font-weight:600">${m.name}</span>${isSelf}<div style="font-size:.8rem;color:var(--text-secondary);margin-top:2px">NIM: ${m.nim}  ${m.points} poin</div></div>
            <span class="${role==='Ketua'?'role-ketua':'role-anggota'}">${role}</span>
        </div>`;
    });
}
function renderActivityLog(team){
    const tbody=document.getElementById('activityLogBody');tbody.innerHTML='';
    if(!team.activities?.length){tbody.innerHTML='<tr><td colspan="2" style="text-align:center;color:var(--text-secondary);padding:20px">Belum ada kegiatan</td></tr>';return;}
    [...team.activities].reverse().forEach(act=>{
        const match=act.match(/\[(.*?)\]/),date=match?match[1]:'-',activity=act.replace(/\[.*?\]/,'').trim();
        tbody.innerHTML+=`<tr><td>${activity}</td><td style="white-space:nowrap;color:var(--text-secondary)">${date}</td></tr>`;
    });
}
function switchTeamTab(tab){
    const tabMap={info:'tabInfo',members:'tabMembers',activities:'tabActivities',chat:'tabChat',manage:'tabManage'};
    Object.values(tabMap).forEach(id=>document.getElementById(id).style.display='none');
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    const el=document.getElementById(tabMap[tab]);if(el)el.style.display='block';
    const tabOrder=['info','members','activities','chat','manage'];
    const idx=tabOrder.indexOf(tab);const btns=document.querySelectorAll('.tab-btn');
    if(btns[idx])btns[idx].classList.add('active');
    if(chatRefreshInterval){clearInterval(chatRefreshInterval);chatRefreshInterval=null;}
    if(tab==='chat'){
        const team=allTeams.find(t=>t.id===currentViewingTeamId);
        const isMember=currentUser&&!currentUser.isAdmin&&currentUser.teams?.includes(team.name);
        document.getElementById('chatAccessDenied').style.display=isMember?'none':'block';
        document.getElementById('chatAccessGranted').style.display=isMember?'block':'none';
        if(isMember){loadChatMessages(team.name);chatRefreshInterval=setInterval(()=>loadChatMessages(team.name,true),3000);}
    }else if(tab==='manage'){loadManageInterface();}
}
async function loadChatMessages(teamName,silent=false){
    const{data}=await db.from('chats').select('*').eq('team_name',teamName).order('timestamp',{ascending:true}).limit(100);
    const messages=data||[],container=document.getElementById('chatMessages');
    if(!messages.length){container.innerHTML='<div style="text-align:center;padding:40px;color:var(--text-secondary)"><p style="font-size:2rem">??</p><p style="margin-top:8px">Belum ada pesan. Mulai percakapan!</p></div>';return;}
    const atBottom=container.scrollHeight-container.scrollTop-container.clientHeight<50;
    container.innerHTML='';
    messages.forEach(msg=>{
        const isOwn=currentUser&&msg.nim===currentUser.nim;
        const div=document.createElement('div');div.style.cssText=`margin-bottom:12px;display:flex;flex-direction:column;${isOwn?'align-items:flex-end':'align-items:flex-start'}`;
        const bubble=document.createElement('div');
        bubble.style.cssText=`max-width:72%;padding:10px 16px;border-radius:18px;word-break:break-word;${isOwn?'background:linear-gradient(135deg,#7B2D8B,#E8395A);color:#fff;border-radius:18px 18px 4px 18px':'background:var(--bg-card);border:2px solid var(--border-color);color:var(--text-primary);border-radius:18px 18px 18px 4px'}`;
        if(!isOwn)bubble.innerHTML=`<div style="font-size:.72rem;font-weight:700;margin-bottom:4px;opacity:.8">${msg.sender}</div>`;
        bubble.innerHTML+=`<div style="line-height:1.5">${msg.message}</div><div style="font-size:.65rem;opacity:.65;margin-top:4px;text-align:right">${new Date(msg.timestamp).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'})}</div>`;
        div.appendChild(bubble);container.appendChild(div);
    });
    if(!silent||atBottom)container.scrollTop=container.scrollHeight;
}
async function sendMessage(){
    if(!currentUser||currentUser.isAdmin)return;
    const input=document.getElementById('chatInput'),text=input.value.trim();if(!text)return;
    const team=allTeams.find(t=>t.id===currentViewingTeamId);
    if(!team||!currentUser.teams?.includes(team.name))return;
    input.value='';
    await db.from('chats').insert({team_name:team.name,nim:currentUser.nim,sender:currentUser.name,message:text,timestamp:Date.now()});
    loadChatMessages(team.name);
}
function shareTeamLink(){
    const team=allTeams.find(t=>t.id===currentViewingTeamId);if(!team)return;
    const link=window.location.href.split('?')[0]+'?team='+team.id;
    navigator.clipboard.writeText(link).then(()=>{const toast=document.getElementById('copiedToast');toast.style.display='block';setTimeout(()=>toast.style.display='none',2500);}).catch(()=>alert('Link tim:\n'+link));
}

/* ============================================================
   TEAM SETTINGS
============================================================ */
function openTeamSettings(){
    const team=allTeams.find(t=>t.id===currentViewingTeamId);if(!team)return;
    const isLeader=currentUser&&!currentUser.isAdmin&&currentUser.team_roles?.[team.name]==='Ketua';
    if(!isLeader){alert('Hanya ketua tim yang bisa akses pengaturan!');return;}
    const prev=document.getElementById('teamLogoPreview');
    prev.innerHTML=team.logo?`<img src="${team.logo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`:`<span id="teamLogoText">${team.logo_text}</span>`;
    document.getElementById('settingsName').value=team.name;document.getElementById('settingsVisi').value=team.visi||'';
    document.getElementById('settingsFocus').value=team.focus||'';document.getElementById('settingsDev').value=team.dev||'';
    const badgesList=document.getElementById('settingsBadgesList');badgesList.innerHTML='';
    const available=team.available_badges||[];
    if(!available.length){badgesList.innerHTML='<p style="color:var(--text-secondary);padding:10px;font-size:.9rem">?? Belum ada lencana dari admin.</p>';}
    else{
        const standardNames={members:'?? Anggota Terbanyak',active:'? Tim Teraktif',creative:'?? Tim Terkreatif',achievement:'?? Tim Terprestasi'};
        available.forEach(bid=>{
            const isActive=team.badges?.includes(bid);let badgeName=standardNames[bid]||'';
            if(!badgeName){const cb=allCustomBadges.find(b=>b.badge_id===bid);if(cb){badgeName=(cb.photo?'??':cb.emoji||'')+' '+cb.name;}}
            badgesList.innerHTML+=`<div style="padding:12px;background:${isActive?'#e8f5e9':'var(--bg-main)'};border-radius:8px;margin-bottom:8px;display:flex;align-items:center;gap:10px;border:2px solid ${isActive?'var(--success)':'var(--border-color)'}">
                <input type="checkbox" id="badge_${bid}" ${isActive?'checked':''} style="width:18px;height:18px;cursor:pointer;accent-color:var(--primary)">
                <label for="badge_${bid}" style="display:inline;font-weight:600;cursor:pointer;color:var(--text-primary)">${badgeName}</label>
                ${isActive?'<span style="margin-left:auto;color:var(--success);font-size:.8rem">? Aktif</span>':''}
            </div>`;
        });
    }
    uploadedTeamLogo=null;openModal('teamSettingsModal');
}
function previewTeamLogo(event){
    const file=event.target.files[0];if(!file)return;
    if(!file.type.startsWith('image/')){alert('File harus gambar!');return;}
    if(file.size>2*1024*1024){alert('Maksimal 2MB!');return;}
    const reader=new FileReader();
    reader.onload=e=>{uploadedTeamLogo=e.target.result;document.getElementById('teamLogoPreview').innerHTML=`<img src="${uploadedTeamLogo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;};
    reader.readAsDataURL(file);
}
async function saveTeamSettings(){
    const team=allTeams.find(t=>t.id===currentViewingTeamId);if(!team)return;
    const oldName=team.name,newName=document.getElementById('settingsName').value.trim();
    const visi=document.getElementById('settingsVisi').value.trim(),focus=document.getElementById('settingsFocus').value.trim(),dev=document.getElementById('settingsDev').value.trim();
    if(!newName||!focus){alert('Nama dan fokus wajib diisi!');return;}
    const selectedBadges=[];
    (team.available_badges||[]).forEach(bid=>{const cb=document.getElementById('badge_'+bid);if(cb&&cb.checked)selectedBadges.push(bid);});
    if(selectedBadges.length>3){alert('Maksimal 3 lencana!');return;}
    showLoading();
    try{
        const updateData={name:newName,visi,focus,dev,badges:selectedBadges};
        if(uploadedTeamLogo){updateData.logo=uploadedTeamLogo;updateData.logo_text=newName.substring(0,2).toUpperCase();}
        await db.from('teams').update(updateData).eq('id',team.id);
        if(oldName!==newName){
            const affected=allUsers.filter(u=>u.teams?.includes(oldName));
            for(const u of affected){
                const newTeams=u.teams.map(t=>t===oldName?newName:t),newRoles={};
                Object.keys(u.team_roles||{}).forEach(k=>{newRoles[k===oldName?newName:k]=u.team_roles[k];});
                await db.from('users').update({teams:newTeams,team_roles:newRoles}).eq('nim',u.nim);
            }
            if(currentUser?.teams?.includes(oldName)){
                currentUser.teams=currentUser.teams.map(t=>t===oldName?newName:t);
                const nr={};Object.keys(currentUser.team_roles||{}).forEach(k=>{nr[k===oldName?newName:k]=currentUser.team_roles[k];});
                currentUser.team_roles=nr;
            }
        }
        uploadedTeamLogo=null;await loadAllData();alert('? Pengaturan tim berhasil disimpan!');
        closeModal('teamSettingsModal');renderTables();openTeamDetail(team.id);
    }catch(e){alert('? Gagal: '+e.message);}finally{hideLoading();}
}
function loadManageInterface(){
    const team=allTeams.find(t=>t.id===currentViewingTeamId);if(!team)return;
    const container=document.getElementById('manageMembers');container.innerHTML='';
    const members=allUsers.filter(u=>u.teams?.includes(team.name));
    if(!members.length){container.innerHTML='<p style="color:var(--text-secondary);text-align:center;padding:20px">Belum ada anggota</p>';return;}
    members.forEach(member=>{
        const role=member.team_roles?.[team.name]||'Anggota',isLeader=role==='Ketua',isSelf=currentUser&&member.nim===currentUser.nim;
        const div=document.createElement('div');div.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:14px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:10px;margin-bottom:10px;gap:10px';
        div.innerHTML=`<div style="flex:1"><div style="font-weight:700;color:var(--text-primary)">${member.name}${isSelf?' <span style="color:var(--primary);font-size:.8rem">(Anda)</span>':''}</div><div style="font-size:.8rem;color:var(--text-secondary);margin-top:3px">NIM: ${member.nim} | ${member.points} poin</div><span class="${isLeader?'role-ketua':'role-anggota'}" style="margin-top:5px;display:inline-block">${role}</span></div><div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end" id="act_${member.nim}"></div>`;
        container.appendChild(div);
        if(!isSelf){
            const actDiv=document.getElementById('act_'+member.nim);
            if(isLeader){actDiv.innerHTML=`<button onclick="changeMemberRole('${member.nim}','Anggota')" style="padding:7px 12px;border:none;border-radius:6px;cursor:pointer;font-size:.8rem;font-weight:700;background:var(--warning);color:#000;font-family:'Nunito',sans-serif">?? Turunkan</button>`;}
            else{actDiv.innerHTML=`<button onclick="changeMemberRole('${member.nim}','Ketua')" style="padding:7px 12px;border:none;border-radius:6px;cursor:pointer;font-size:.8rem;font-weight:700;background:var(--success);color:#fff;font-family:'Nunito',sans-serif">?? Ketua</button><button onclick="kickMember('${member.nim}')" style="padding:7px 12px;border:none;border-radius:6px;cursor:pointer;font-size:.8rem;font-weight:700;background:var(--danger);color:#fff;font-family:'Nunito',sans-serif">?? Keluarkan</button>`;}
        }
    });
}
async function changeMemberRole(nim,newRole){
    const team=allTeams.find(t=>t.id===currentViewingTeamId),member=allUsers.find(u=>u.nim===nim);if(!team||!member)return;
    if(newRole==='Ketua'){
        if(!confirm(`Jadikan ${member.name} sebagai Ketua?\n\n?? Anda akan otomatis menjadi Anggota biasa!`))return;
        const oldLeader=allUsers.find(u=>u.teams?.includes(team.name)&&u.team_roles?.[team.name]==='Ketua');
        if(oldLeader){const lr={...oldLeader.team_roles,[team.name]:'Anggota'};await db.from('users').update({team_roles:lr}).eq('nim',oldLeader.nim);oldLeader.team_roles=lr;if(currentUser?.nim===oldLeader.nim)currentUser.team_roles=lr;}
    }else{if(!confirm(`Turunkan ${member.name} dari posisi Ketua?`))return;}
    const nr={...member.team_roles,[team.name]:newRole};await db.from('users').update({team_roles:nr}).eq('nim',nim);member.team_roles=nr;
    alert(`? ${member.name} sekarang menjadi ${newRole}!`);await loadAllData();openTeamDetail(team.id);renderTables();
}
async function kickMember(nim){
    const team=allTeams.find(t=>t.id===currentViewingTeamId),member=allUsers.find(u=>u.nim===nim);if(!team||!member)return;
    if(!confirm(`?? KELUARKAN "${member.name}" dari tim "${team.name}"?`))return;showLoading();
    try{
        const newTeams=member.teams.filter(t=>t!==team.name),newRoles={...member.team_roles};delete newRoles[team.name];
        await db.from('users').update({teams:newTeams,team_roles:newRoles}).eq('nim',nim);
        member.teams=newTeams;member.team_roles=newRoles;
        alert(`? ${member.name} telah dikeluarkan dari tim!`);loadManageInterface();renderTeamMembers(team.name);renderTables();
    }catch(e){alert('? Gagal: '+e.message);}finally{hideLoading();}
}

/* ============================================================
   USER PROFILE (profil sendiri)
============================================================ */
function openUserProfile(){
    if(!currentUser)return;
    document.getElementById('adminPanelSection').style.display=currentUser.isAdmin?'block':'none';
    document.getElementById('cvProfileSection').style.display=currentUser.isAdmin?'none':'block';
    if(!currentUser.isAdmin)renderCVProfile();openModal('userProfileModal');
}
function renderCVProfile(){
    const av=currentUser.name.substring(0,2).toUpperCase();
    document.getElementById('cvAvatar').innerHTML=currentUser.profile_photo?`<img src="${currentUser.profile_photo}" style="width:100%;height:100%;object-fit:cover">`:`<span id="cvAvatarText">${av}</span>`;
    document.getElementById('cvName').innerText=currentUser.name;document.getElementById('cvNim').innerText='NIM: '+currentUser.nim;document.getElementById('cvKelas').innerText='Kelas: '+(currentUser.kelas||'-');
    const teams=[...new Set(currentUser.teams||[])],roles=teams.map(t=>`${t} - ${currentUser.team_roles?.[t]||'Anggota'}`).join('<br>')||'-';
    document.getElementById('cvTitle').innerHTML=roles;document.getElementById('cvTeamRole').innerHTML=roles;document.getElementById('cvPoints').innerText=currentUser.points;
    const sorted=allUsers.filter(u=>!u.is_admin).sort((a,b)=>b.points-a.points),rank=sorted.findIndex(u=>u.nim===currentUser.nim)+1;
    document.getElementById('cvRank').innerText=`#${rank} dari ${sorted.length} peserta`;
    const achDiv=document.getElementById('cvAchievements');
    if(!currentUser.achievements?.length){achDiv.innerHTML='<p style="color:var(--text-secondary);text-align:center;padding:20px">Belum ada prestasi yang dicatat</p>';}
    else{
        achDiv.innerHTML='';[...currentUser.achievements].reverse().forEach(a=>{
            const cls=a.type==='latihan'?'point-latihan':a.type==='karya'?'point-karya':'point-lomba';
            const pts=a.type==='latihan'?'+30':a.type==='karya'?'+50':'+70';
            achDiv.innerHTML+=`<div style="background:var(--bg-main);padding:14px;border-radius:10px;margin-bottom:10px;border-left:4px solid var(--success)"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;flex-wrap:wrap;gap:8px"><span class="point-badge ${cls}">${a.type} ${pts} poin</span><span style="font-size:.8rem;color:var(--text-secondary)">${new Date(a.timestamp).toLocaleDateString('id-ID')}</span></div><div style="font-size:.9rem;color:var(--text-primary)">${a.description}</div></div>`;
        });
    }
}
function openEditProfile(){
    const av=currentUser.name.substring(0,2).toUpperCase();
    document.getElementById('editProfilePreview').innerHTML=currentUser.profile_photo?`<img src="${currentUser.profile_photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`:`<span id="editProfileText">${av}</span>`;
    document.getElementById('editName').value=currentUser.name;document.getElementById('editKelas').value=currentUser.kelas||'';
    uploadedProfilePhoto=null;openModal('editProfileModal');
}
function previewProfilePhoto(event){
    const file=event.target.files[0];if(!file)return;
    if(!file.type.startsWith('image/')){alert('File harus gambar!');return;}
    if(file.size>2*1024*1024){alert('Maksimal 2MB!');return;}
    const reader=new FileReader();
    reader.onload=e=>{uploadedProfilePhoto=e.target.result;document.getElementById('editProfilePreview').innerHTML=`<img src="${uploadedProfilePhoto}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;};
    reader.readAsDataURL(file);
}
async function saveProfile(){
    const name=document.getElementById('editName').value.trim(),kelas=document.getElementById('editKelas').value.trim();
    if(!name){alert('Nama tidak boleh kosong!');return;}showLoading();
    try{
        const updateData={name,kelas};if(uploadedProfilePhoto)updateData.profile_photo=uploadedProfilePhoto;
        await db.from('users').update(updateData).eq('nim',currentUser.nim);
        currentUser.name=name;currentUser.kelas=kelas;if(uploadedProfilePhoto)currentUser.profile_photo=uploadedProfilePhoto;
        const u=allUsers.find(u=>u.nim===currentUser.nim);if(u){u.name=name;u.kelas=kelas;if(uploadedProfilePhoto)u.profile_photo=uploadedProfilePhoto;}
        alert('? Profil berhasil diperbarui!');uploadedProfilePhoto=null;closeModal('editProfileModal');renderCVProfile();updateHomepageUI();renderTables();
    }catch(e){alert('? Gagal: '+e.message);}finally{hideLoading();}
}
function openMyTeamPage(){
    if(!currentUser?.teams?.length){alert('Anda belum bergabung dengan tim!');return;}
    const myTeam=allTeams.find(t=>t.name===currentUser.teams[0]);
    if(myTeam){closeModal('userProfileModal');openTeamDetail(myTeam.id);}else alert('Tim tidak ditemukan!');
}
function downloadCV(){
    if(!currentUser)return;const{jsPDF}=window.jspdf;const doc=new jsPDF();
    doc.setFillColor(123,45,139);doc.rect(0,0,210,55,'F');doc.setFillColor(232,57,90);doc.rect(0,48,210,7,'F');
    doc.setTextColor(255,255,255);doc.setFontSize(26);doc.setFont(undefined,'bold');doc.text('CURRICULUM VITAE',105,22,{align:'center'});
    doc.setFontSize(14);doc.setFont(undefined,'normal');doc.text(currentUser.name,105,36,{align:'center'});
    doc.setFontSize(11);doc.text((currentUser.teams||[]).join(' | ')||'Belum bergabung tim',105,47,{align:'center'});
    doc.setTextColor(0,0,0);let y=70;
    const section=title=>{doc.setFontSize(13);doc.setFont(undefined,'bold');doc.setFillColor(123,45,139);doc.rect(15,y-5,180,8,'F');doc.setTextColor(255,255,255);doc.text(title,20,y+1);doc.setTextColor(0,0,0);doc.setFont(undefined,'normal');doc.setFontSize(11);y+=12;};
    const line=(label,val)=>{doc.setFont(undefined,'bold');doc.text(label+':',20,y);doc.setFont(undefined,'normal');doc.text(String(val||'-'),70,y);y+=8;};
    section('INFORMASI PRIBADI');line('NIM',currentUser.nim);line('Nama',currentUser.name);line('Kelas',currentUser.kelas||'-');line('Tim',(currentUser.teams||[]).join(', ')||'-');line('Peran',(currentUser.teams||[]).map(t=>`${t}: ${currentUser.team_roles?.[t]||'Anggota'}`).join(', ')||'-');y+=5;
    section('STATISTIK');line('Total Poin',currentUser.points);const sorted=allUsers.filter(u=>!u.is_admin).sort((a,b)=>b.points-a.points),rank=sorted.findIndex(u=>u.nim===currentUser.nim)+1;line('Peringkat',`#${rank} dari ${sorted.length} peserta`);y+=5;
    if(currentUser.achievements?.length){
        section('RIWAYAT PRESTASI');doc.setFontSize(10);doc.setFont(undefined,'normal');
        currentUser.achievements.forEach((a,i)=>{
            if(y>270){doc.addPage();y=20;}
            const typeLabel=a.type==='latihan'?'Latihan':a.type==='karya'?'Karya':'Lomba',pts=a.type==='latihan'?30:a.type==='karya'?50:70;
            doc.setFont(undefined,'bold');doc.text(`${i+1}. [${typeLabel} +${pts} poin]`,20,y);doc.setFont(undefined,'normal');y+=7;
            const lines=doc.splitTextToSize(a.description,160);doc.text(lines,25,y);y+=lines.length*6+3;
        });
    }
    doc.setFontSize(9);doc.setTextColor(150,150,150);doc.text(`Dicetak: ${new Date().toLocaleDateString('id-ID')} | Grup Karya Platform`,105,290,{align:'center'});
    doc.save('CV_'+currentUser.name.replace(/\s+/g,'_')+'.pdf');alert('? CV berhasil didownload!');
}

/* ============================================================
   ADMIN FUNCTIONS
============================================================ */
async function adminAddPoints(){
    const sel=document.getElementById('pointTeamSelect');sel.innerHTML='<option value="">-- Pilih Tim --</option>';
    allTeams.forEach(t=>sel.innerHTML+=`<option value="${t.id}">${t.name}</option>`);
    document.getElementById('pointMemberSelect').innerHTML='<option value="">-- Pilih tim dulu --</option>';
    document.getElementById('pointTypeSelect').value='';document.getElementById('pointDesc').value='';openModal('addPointsModal');
}
async function loadTeamMembers(){
    const teamId=parseInt(document.getElementById('pointTeamSelect').value),sel=document.getElementById('pointMemberSelect');
    if(!teamId){sel.innerHTML='<option value="">-- Pilih tim dulu --</option>';return;}
    const team=allTeams.find(t=>t.id===teamId),members=allUsers.filter(u=>u.teams?.includes(team.name));
    sel.innerHTML='<option value="">-- Pilih Anggota --</option>';
    members.sort((a,b)=>{const ra=a.team_roles?.[team.name]||'Anggota',rb=b.team_roles?.[team.name]||'Anggota';return ra==='Ketua'?-1:rb==='Ketua'?1:0;})
    .forEach(m=>{const role=m.team_roles?.[team.name]||'Anggota';sel.innerHTML+=`<option value="${m.nim}">${m.name} (${role}) - ${m.points} poin</option>`;});
}
async function submitAddPoints(){
    const teamId=parseInt(document.getElementById('pointTeamSelect').value),nim=document.getElementById('pointMemberSelect').value;
    const type=document.getElementById('pointTypeSelect').value,desc=document.getElementById('pointDesc').value.trim();
    if(!teamId||!nim||!type||!desc){alert('Semua field wajib diisi!');return;}showLoading();
    try{
        /* FIX BUG: Poin lomba sekarang benar 70 */
        const pts=type==='latihan'?30:type==='karya'?50:70;
        const team=allTeams.find(t=>t.id===teamId),member=allUsers.find(u=>u.nim===nim);
        const newAch=[...(member.achievements||[]),{type,description:desc,points:pts,timestamp:Date.now()}];
        /* Simpan point_log dengan timestamp untuk grafik real-time */
        const newLog=[...(member.point_logs||[]),{type,description:desc,points:pts,timestamp:Date.now()}];
        await db.from('users').update({points:member.points+pts,achievements:newAch,point_logs:newLog}).eq('nim',nim);
        member.points+=pts;member.achievements=newAch;member.point_logs=newLog;
        if(currentUser?.nim===nim){currentUser.points+=pts;currentUser.achievements=newAch;currentUser.point_logs=newLog;}
        const typeText=type==='latihan'?'Latihan Wajib':type==='karya'?'Karya':'Lomba';
        const newActs=[...(team.activities||[]),`${typeText}: ${desc} - ${member.name} (+${pts} poin) [${new Date().toLocaleDateString('id-ID')}]`];
        await db.from('teams').update({points:team.points+pts,activities:newActs}).eq('id',teamId);
        team.points+=pts;team.activities=newActs;
        /* Refresh grafik setelah poin ditambah */
        initChart();
        alert(`? Berhasil tambah ${pts} poin ke ${member.name}!\nTotal poin: ${member.points}`);closeModal('addPointsModal');renderTables();
    }catch(e){alert('? Gagal: '+e.message);}finally{hideLoading();}
}
async function adminAddBadge(){
    const teamSel=document.getElementById('badgeTeamSelect');teamSel.innerHTML='<option value="">-- Pilih Tim --</option>';
    allTeams.forEach(t=>teamSel.innerHTML+=`<option value="${t.id}">${t.name}</option>`);
    const badgeSel=document.getElementById('badgeTypeSelect');
    badgeSel.innerHTML=`<option value="">-- Pilih Lencana --</option><optgroup label="?? Lencana Standar"><option value="members">?? Anggota Terbanyak</option><option value="active">? Tim Teraktif</option><option value="creative">?? Tim Terkreatif</option><option value="achievement">?? Tim Terprestasi</option></optgroup>`;
    if(allCustomBadges.length>0){badgeSel.innerHTML+=`<optgroup label="? Lencana Custom">`;allCustomBadges.forEach(b=>{const icon=b.photo?'??':(b.emoji||'');badgeSel.innerHTML+=`<option value="${b.badge_id}">${icon} ${b.name}</option>`;});badgeSel.innerHTML+=`</optgroup>`;}
    document.getElementById('badgePreviewBox').style.display='none';badgeSel.onchange=function(){updateBadgeSendPreview(this.value);};openModal('addBadgeModal');
}
function updateBadgeSendPreview(badgeId){
    const box=document.getElementById('badgePreviewBox'),prev=document.getElementById('badgeSendPreview'),name=document.getElementById('badgeSendName');
    if(!badgeId){box.style.display='none';return;}
    box.style.display='block';
    const si={members:{icon:'??',color:'linear-gradient(135deg,#ff9800,#f57c00)',name:'Anggota Terbanyak'},active:{icon:'?',color:'linear-gradient(135deg,#4caf50,#388e3c)',name:'Tim Teraktif'},creative:{icon:'??',color:'linear-gradient(135deg,#9c27b0,#7b1fa2)',name:'Tim Terkreatif'},achievement:{icon:'??',color:'linear-gradient(135deg,#f44336,#d32f2f)',name:'Tim Terprestasi'}};
    if(si[badgeId]){prev.style.background=si[badgeId].color;prev.innerHTML=si[badgeId].icon;name.innerText=si[badgeId].name;}
    else{const cb=allCustomBadges.find(b=>b.badge_id===badgeId);if(cb){prev.style.background=cb.photo?'#f5f5f5':(cb.color||'linear-gradient(135deg,#ffd700,#ff8c00)');prev.innerHTML=cb.photo?`<img src="${cb.photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`:(cb.emoji||'');name.innerText=cb.name;}}
}
async function submitAddBadge(){
    const teamId=parseInt(document.getElementById('badgeTeamSelect').value),badge=document.getElementById('badgeTypeSelect').value;
    if(!teamId||!badge){alert('Semua field wajib diisi!');return;}
    const team=allTeams.find(t=>t.id===teamId);if(team.available_badges?.includes(badge)){alert('Lencana ini sudah pernah dikirim!');return;}
    showLoading();
    try{
        const newBadges=[...(team.available_badges||[]),badge];
        await db.from('teams').update({available_badges:newBadges}).eq('id',teamId);team.available_badges=newBadges;
        const badgeName=document.getElementById('badgeSendName').innerText||badge;
        alert(`? Lencana "${badgeName}" berhasil dikirim ke tim ${team.name}!`);closeModal('addBadgeModal');await loadAllData();
    }catch(e){alert('? Gagal: '+e.message);}finally{hideLoading();}
}

/* ============================================================
   BADGE DESIGNER
============================================================ */
function openDesainLencana(){
    currentBadgeDesign={id:null,name:'',emoji:'',photo:null,color:'linear-gradient(135deg,#ffd700,#ff8c00)'};
    document.getElementById('badgeNameInput').value='';document.getElementById('badgeEmojiInput').value='';document.getElementById('badgePhotoInput').value='';
    document.getElementById('badgePhotoPreviewBox').style.display='none';
    document.querySelectorAll('.emoji-btn').forEach(b=>b.classList.remove('selected'));
    document.querySelectorAll('.color-opt').forEach(c=>c.classList.remove('selected'));
    const firstEmoji=document.querySelector('.emoji-btn');if(firstEmoji)firstEmoji.classList.add('selected');
    const firstColor=document.querySelector('.color-opt');if(firstColor)firstColor.classList.add('selected');
    updateBadgePreview();closeModal('daftarLencanaModal');openModal('desainLencanaModal');
}
function selectEmoji(emoji){
    currentBadgeDesign.emoji=emoji;currentBadgeDesign.photo=null;
    document.getElementById('badgeEmojiInput').value=emoji;document.getElementById('badgePhotoPreviewBox').style.display='none';document.getElementById('badgePhotoInput').value='';
    document.querySelectorAll('.emoji-btn').forEach(b=>b.classList.toggle('selected',b.innerText.trim()===emoji));updateBadgePreview();
}
function selectBadgeColor(color){
    currentBadgeDesign.color=color;document.querySelectorAll('.color-opt').forEach(c=>c.classList.toggle('selected',c.style.background===color));updateBadgePreview();
}
function previewBadgePhoto(event){
    const file=event.target.files[0];if(!file)return;
    if(!file.type.startsWith('image/')){alert('File harus gambar!');return;}
    if(file.size>1*1024*1024){alert('Maksimal 1MB!');return;}
    const reader=new FileReader();
    reader.onload=e=>{
        currentBadgeDesign.photo=e.target.result;currentBadgeDesign.emoji=null;
        document.getElementById('badgeEmojiInput').value='';document.querySelectorAll('.emoji-btn').forEach(b=>b.classList.remove('selected'));
        document.getElementById('badgePhotoPreviewImg').src=e.target.result;document.getElementById('badgePhotoPreviewBox').style.display='block';updateBadgePreview();
    };reader.readAsDataURL(file);
}
function clearBadgePhoto(){
    currentBadgeDesign.photo=null;currentBadgeDesign.emoji='';
    document.getElementById('badgePhotoInput').value='';document.getElementById('badgePhotoPreviewBox').style.display='none';document.getElementById('badgeEmojiInput').value='';
    const firstEmoji=document.querySelector('.emoji-btn');if(firstEmoji)firstEmoji.classList.add('selected');updateBadgePreview();
}
function updateBadgePreview(){
    const name=document.getElementById('badgeNameInput')?.value||'Nama Lencana';
    const emojiInput=document.getElementById('badgeEmojiInput')?.value;
    if(emojiInput&&!currentBadgeDesign.photo)currentBadgeDesign.emoji=emojiInput;
    const content=currentBadgeDesign.photo?`<img src="${currentBadgeDesign.photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`:(currentBadgeDesign.emoji||'');
    const bg=currentBadgeDesign.photo?'#f5f5f5':currentBadgeDesign.color;
    const large=document.getElementById('badgePreviewLarge'),small=document.getElementById('badgePreviewSmall');
    if(large){large.style.background=bg;large.innerHTML=content;}if(small){small.style.background=bg;small.innerHTML=content;}
    const nameEl=document.getElementById('badgePreviewName'),nameSmallEl=document.getElementById('badgePreviewNameSmall');
    if(nameEl)nameEl.innerText=name;if(nameSmallEl)nameSmallEl.innerText=name;
}
async function simpanDesainLencana(){
    const name=document.getElementById('badgeNameInput').value.trim();if(!name){alert('Nama lencana wajib diisi!');return;}
    const emojiInput=document.getElementById('badgeEmojiInput').value;if(emojiInput)currentBadgeDesign.emoji=emojiInput;
    if(!currentBadgeDesign.emoji&&!currentBadgeDesign.photo){alert('Pilih emoji atau upload foto!');return;}
    showLoading();
    try{
        const newId='custom_'+Date.now();
        const badgeData={badge_id:newId,name,emoji:currentBadgeDesign.photo?null:(currentBadgeDesign.emoji||''),photo:currentBadgeDesign.photo||null,color:currentBadgeDesign.color,created_at:Date.now()};
        const{error}=await db.from('custom_badges').insert(badgeData);
        if(error){const existing=JSON.parse(localStorage.getItem('gk_custom_badges')||'[]');existing.push(badgeData);localStorage.setItem('gk_custom_badges',JSON.stringify(existing));allCustomBadges.push(badgeData);}
        else{allCustomBadges.unshift(badgeData);}
        alert(`? Lencana "${name}" berhasil dibuat!`);closeModal('desainLencanaModal');
    }catch(e){
        const newId='custom_'+Date.now();const badgeData={badge_id:newId,name,emoji:currentBadgeDesign.photo?null:(currentBadgeDesign.emoji||''),photo:currentBadgeDesign.photo||null,color:currentBadgeDesign.color,created_at:Date.now()};
        const existing=JSON.parse(localStorage.getItem('gk_custom_badges')||'[]');existing.push(badgeData);localStorage.setItem('gk_custom_badges',JSON.stringify(existing));allCustomBadges.unshift(badgeData);
        alert(`? Lencana "${name}" berhasil dibuat! (lokal)`);closeModal('desainLencanaModal');
    }finally{hideLoading();}
}
async function lihatDaftarLencana(){
    await loadAllData();const container=document.getElementById('daftarLencanaList');container.innerHTML='';
    if(!allCustomBadges.length){container.innerHTML='<div style="text-align:center;padding:40px;color:var(--text-secondary)"><p style="font-size:3rem">??</p><p style="margin-top:10px">Belum ada lencana custom.</p></div>';openModal('daftarLencanaModal');return;}
    allCustomBadges.forEach(b=>{
        const content=b.photo?`<img src="${b.photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`:(b.emoji||'');
        const bg=b.photo?'#f5f5f5':(b.color||'linear-gradient(135deg,#ffd700,#ff8c00)');
        const div=document.createElement('div');div.className='badge-card';
        div.innerHTML=`<div style="width:55px;height:55px;border-radius:50%;background:${bg};display:flex;align-items:center;justify-content:center;font-size:1.6rem;flex-shrink:0;overflow:hidden;border:3px solid var(--border-color)">${content}</div>
            <div style="flex:1"><div style="font-weight:700;color:var(--text-primary);font-size:1rem">${b.name}</div><div style="font-size:.8rem;color:var(--text-secondary);margin-top:3px">ID: ${b.badge_id}</div><div style="font-size:.8rem;color:var(--text-secondary)">Dibuat: ${new Date(b.created_at).toLocaleDateString('id-ID')}</div></div>
            <button onclick="hapusLencanaCustom('${b.badge_id}')" style="background:var(--danger);color:#fff;border:none;border-radius:8px;padding:8px 14px;cursor:pointer;font-weight:700;font-size:.85rem;flex-shrink:0;font-family:'Nunito',sans-serif">??? Hapus</button>`;
        container.appendChild(div);
    });openModal('daftarLencanaModal');
}
async function hapusLencanaCustom(badgeId){
    const badge=allCustomBadges.find(b=>b.badge_id===badgeId);if(!badge)return;
    if(!confirm(`??? HAPUS lencana "${badge.name}"?`))return;showLoading();
    try{
        await db.from('custom_badges').delete().eq('badge_id',badgeId);
        for(const team of allTeams){
            const newBadges=(team.badges||[]).filter(b=>b!==badgeId),newAvailable=(team.available_badges||[]).filter(b=>b!==badgeId);
            if(newBadges.length!==team.badges?.length||newAvailable.length!==team.available_badges?.length)
                await db.from('teams').update({badges:newBadges,available_badges:newAvailable}).eq('id',team.id);
        }
        allCustomBadges=allCustomBadges.filter(b=>b.badge_id!==badgeId);
        alert(`? Lencana "${badge.name}" berhasil dihapus!`);lihatDaftarLencana();await loadAllData();renderTables();
    }catch(e){alert('? Gagal: '+e.message);}finally{hideLoading();}
}
async function adminDeleteTeam(){
    const container=document.getElementById('deleteTeamList');container.innerHTML='';
    if(!allTeams.length){container.innerHTML='<p style="text-align:center;padding:20px;color:var(--text-secondary)">Belum ada tim</p>';openModal('deleteTeamModal');return;}
    allTeams.forEach(t=>{
        const members=allUsers.filter(u=>u.teams?.includes(t.name)).length;
        const div=document.createElement('div');div.style.cssText='background:var(--bg-card);padding:15px;border-radius:10px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border-color)';
        div.innerHTML=`<div><div style="font-weight:700;color:var(--text-primary)">${t.name}</div><div style="font-size:.85rem;color:var(--text-secondary);margin-top:3px">${t.focus}  ${t.points} poin  ${members} anggota</div></div><button onclick="confirmDeleteTeam(${t.id})" style="padding:8px 16px;border:none;border-radius:8px;cursor:pointer;font-weight:700;background:var(--danger);color:#fff;flex-shrink:0;font-family:'Nunito',sans-serif">??? Hapus</button>`;
        container.appendChild(div);
    });openModal('deleteTeamModal');
}
async function confirmDeleteTeam(teamId){
    const team=allTeams.find(t=>t.id===teamId);
    if(!confirm(`??? HAPUS TIM "${team.name}"?\n${allUsers.filter(u=>u.teams?.includes(team.name)).length} anggota akan kehilangan tim ini!`))return;
    showLoading();
    try{
        const affected=allUsers.filter(u=>u.teams?.includes(team.name));
        for(const u of affected){const newTeams=u.teams.filter(t=>t!==team.name),newRoles={...u.team_roles};delete newRoles[team.name];await db.from('users').update({teams:newTeams,team_roles:newRoles}).eq('nim',u.nim);}
        await db.from('teams').delete().eq('id',teamId);await db.from('chats').delete().eq('team_name',team.name);
        alert(`? Tim "${team.name}" berhasil dihapus!`);closeModal('deleteTeamModal');await loadAllData();renderTables();
    }catch(e){alert('? Gagal: '+e.message);}finally{hideLoading();}
}
async function adminDeleteUser(){
    const container=document.getElementById('deleteUserList');container.innerHTML='';
    const regularUsers=allUsers.filter(u=>!u.is_admin);
    if(!regularUsers.length){container.innerHTML='<p style="text-align:center;padding:20px;color:var(--text-secondary)">Belum ada user</p>';openModal('deleteUserModal');return;}
    regularUsers.forEach(u=>{
        const div=document.createElement('div');div.style.cssText='background:var(--bg-card);padding:15px;border-radius:10px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border-color)';
        div.innerHTML=`<div><div style="font-weight:700;color:var(--text-primary)">${u.name}</div><div style="font-size:.85rem;color:var(--text-secondary);margin-top:3px">NIM: ${u.nim} | Tim: ${(u.teams||[]).join(', ')||'-'} | ${u.points} poin</div></div><button onclick="confirmDeleteUser('${u.nim}')" style="padding:8px 16px;border:none;border-radius:8px;cursor:pointer;font-weight:700;background:var(--danger);color:#fff;flex-shrink:0;font-family:'Nunito',sans-serif">??? Hapus</button>`;
        container.appendChild(div);
    });openModal('deleteUserModal');
}
async function confirmDeleteUser(nim){
    const user=allUsers.find(u=>u.nim===nim);
    if(!confirm(`??? HAPUS AKUN "${user.name}" (NIM: ${user.nim})?`))return;showLoading();
    try{await db.from('users').delete().eq('nim',nim);allUsers=allUsers.filter(u=>u.nim!==nim);alert(`? Akun "${user.name}" berhasil dihapus!`);closeModal('deleteUserModal');renderTables();}
    catch(e){alert('? Gagal: '+e.message);}finally{hideLoading();}
}
async function adminDeletePost(){
    const container=document.getElementById('deletePostList');container.innerHTML='';
    if(!allPosts.length){container.innerHTML='<p style="text-align:center;padding:30px;color:var(--text-secondary)">Belum ada postingan</p>';openModal('deletePostModal');return;}
    allPosts.forEach(p=>{
        const div=document.createElement('div');div.style.cssText='background:var(--bg-card);padding:15px;border-radius:10px;margin-bottom:10px;border:1px solid var(--border-color)';
        div.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px"><div style="flex:1"><div style="font-weight:700;color:var(--text-primary)">${p.author_name}</div><div style="font-size:.8rem;color:var(--text-secondary);margin-bottom:8px">${p.author_team}  ${getTimeAgo(p.timestamp)}</div><div style="color:var(--text-primary);font-size:.9rem;line-height:1.5">${p.content?(p.content.length>100?p.content.substring(0,100)+'...':p.content):'<em style="color:var(--text-secondary)">Hanya foto</em>'}</div>${p.image?'<div style="margin-top:6px;font-size:.8rem;color:var(--primary)">??? Ada foto</div>':''}</div><button onclick="confirmDeletePost(${p.id})" style="padding:8px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700;background:var(--danger);color:#fff;flex-shrink:0;font-family:'Nunito',sans-serif">???</button></div>`;
        container.appendChild(div);
    });openModal('deletePostModal');
}
async function confirmDeletePost(postId){
    if(!confirm('Hapus postingan ini?'))return;showLoading();
    await db.from('posts').delete().eq('id',postId);allPosts=allPosts.filter(p=>p.id!==postId);renderFeed();closeModal('deletePostModal');hideLoading();
}
async function downloadExcelData(){
    showLoading();
    try{
        const{data}=await db.from('users').select('*').eq('is_admin',false).order('points',{ascending:false});
        const rows=(data||[]).map((u,i)=>({'Peringkat':i+1,'Nama':u.name,'NIM':u.nim,'Kelas':u.kelas||'-','Tim':(u.teams||[]).join(', ')||'-','Peran':(u.teams||[]).map(t=>`${t}: ${u.team_roles?.[t]||'Anggota'}`).join(', ')||'-','Total Poin':u.points,'Jumlah Prestasi':(u.achievements||[]).length,'Tanggal Daftar':u.join_date?new Date(u.join_date).toLocaleDateString('id-ID'):'-'}));
        const ws=XLSX.utils.json_to_sheet(rows);ws['!cols']=[{wch:10},{wch:25},{wch:15},{wch:12},{wch:25},{wch:30},{wch:12},{wch:16},{wch:18}];
        const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Data Mahasiswa');
        const teamRows=[...allTeams].sort((a,b)=>b.points-a.points).map((t,i)=>({'Peringkat':i+1,'Nama Tim':t.name,'Fokus':t.focus,'Total Poin':t.points,'Jumlah Anggota':allUsers.filter(u=>u.teams?.includes(t.name)).length,'Jumlah Lencana':(t.badges||[]).length}));
        const ws2=XLSX.utils.json_to_sheet(teamRows);ws2['!cols']=[{wch:10},{wch:25},{wch:20},{wch:12},{wch:15},{wch:15}];
        XLSX.utils.book_append_sheet(wb,ws2,'Data Tim');
        XLSX.writeFile(wb,`GrupKarya_${new Date().toLocaleDateString('id-ID').replace(/\//g,'-')}.xlsx`);
        alert('? Data Excel berhasil didownload!\n(2 sheet: Data Mahasiswa & Data Tim)');
    }catch(e){alert('? Gagal: '+e.message);}finally{hideLoading();}
}

/* ============================================================
   BOOT
============================================================ */
/* ============================================================
   GAME MODULE  WHAREWOLF
   Tabel Supabase: ww_rooms, ww_players, ww_messages, ww_actions
   Semua terhapus otomatis setelah game selesai
============================================================ */

/* ----- CONSTANTS ----- */
const WW_ROLES = {
    werewolf: {
        name: '?? Serigala',
        desc: 'Malam hari: Pilih korban untuk dieliminasi. Kirim propaganda anonim.',
        team: 'evil'
    },
    villager: {
        name: '??? Warga Desa',
        desc: 'Tidak punya skill khusus. Kekuatanmu ada di argumentasi siang hari!',
        team: 'good'
    },
    philosopher: {
        name: '?? Filsafat',
        desc: 'Pagi: Sistem mengeluarkan pernyataan ontologis tentang salah satu serigala.',
        team: 'good'
    },
    poet: {
        name: '?? Bujangga Puisi',
        desc: 'Pagi: Sistem merilis puisi simbolik tentang serigala.',
        team: 'good'
    },
    journalist: {
        name: '?? Penulis Koran',
        desc: 'Pagi: Pilih pemain untuk diwawancarai. Sistem memberi jawaban samar.',
        team: 'good'
    },
    detective: {
        name: '?? Detektif',
        desc: 'Pagi: Selidiki 1 pemain. Hasilnya berupa kategori samar, bukan nama langsung.',
        team: 'good'
    }
};

const WW_PHASE = { NIGHT: 'night', MORNING: 'morning', DAY: 'day', VOTE: 'vote' };

const WW_CLUES_PHILOSOPHER = [
    "Yang bersembunyi seringkali paling vokal membicarakan kebenaran.",
    "Eksistensi tanpa esensi seringkali menjadi topeng paling sempurna.",
    "Mereka yang paling keras berteriak tentang keadilan, kadang menyembunyikan predatornya.",
    "Bayangan terpanjang datang dari objek yang paling dekat dengan cahaya.",
    "Absurditas sejati bukan pada pembunuh, tapi pada mereka yang tak mau melihat.",
];
const WW_CLUES_POET = [
    "Ia menyelinap di antara kata-kata,\nbersembunyi dalam metafora gelap.",
    "Di padang sunyi ia berburu,\nmenyamar sebagai penjaga pagi.",
    "Taring tersembunyi di balik senyum,\nbulu halus menutupi cakar tajam.",
    "Gelapnya bukan malam\nmelainkan jiwa yang memilih diam.",
    "Ia minum dari sumur yang sama,\nnamun menuangkan racun di malam hari.",
];
const WW_CLUES_JOURNALIST = [
    "Aku hanya berburu ketika sunyi, bukan saat ramai.",
    "Malam adalah milikku, siang adalah penyamaranku.",
    "Aku bergaul dengan semua, namun loyalitasku hanya satu.",
    "Kata-kataku adalah senjata yang lebih tajam dari taring.",
    "Aku tersenyum karena tahu sesuatu yang kalian tidak tahu.",
];
const WW_CLUES_DETECTIVE = [
    "Berorientasi malam.",
    "Berkaitan dengan bahasa manipulatif.",
    "Cenderung observatif dan predatorik.",
    "Pola bicara defensif saat nama disebut.",
    "Memiliki motif tersembunyi yang kuat.",
];

// Keyword trigger untuk scoring argumen
const WW_TRIGGER_KEYWORDS = ['serigala','berburu','malam','taring','menyamar','manipulatif','predator','gelap','sembunyi','taktik','analisis','klue','petunjuk','indikasi','mencurigakan','tuduh','terbukti'];

/* ----- STATE ----- */
let wwState = {
    roomId: null,
    roomCode: null,
    myNim: null,
    myName: null,
    myRole: null,
    isHost: false,
    players: [],       // [{nim, name, role, alive, score}]
    phase: null,
    round: 1,
    voteTarget: null,
    nightTarget: null,
    myScore: 0,
    gameActive: false,
    actionUsed: false,  // skill sudah dipakai ronde ini
    votesCast: {},      // {voter_nim: target_nim}
    chatInterval: null,
    stateInterval: null,
    timerInterval: null,
    phaseEndTime: null,
    propagandaSent: false,
    pendingKeywordCheck: false,
};

/* ============================================================
   GAME LIST MODAL
============================================================ */
function openGameListModal(){
    if(!currentUser||currentUser.isAdmin){
        alert('Silakan login terlebih dahulu untuk memainkan game!');return;
    }
    openModal('gameListModal');
}
function openWerewolfGame(){
    closeModal('gameListModal');
    wwState.myNim = currentUser.nim;
    wwState.myName = currentUser.name;
    wwResetState();
    document.getElementById('wwOverlay').style.display='flex';
    wwShowLobby();
}
function closeWerewolfGame(){
    if(wwState.gameActive){
        if(!confirm('Yakin keluar dari permainan yang sedang berlangsung?'))return;
    }
    wwCleanupIntervals();
    document.getElementById('wwOverlay').style.display='none';
    wwResetState();
}
function wwResetState(){
    wwState.roomId=null;wwState.roomCode=null;wwState.myRole=null;wwState.isHost=false;
    wwState.players=[];wwState.phase=null;wwState.round=1;wwState.voteTarget=null;
    wwState.nightTarget=null;wwState.myScore=0;wwState.gameActive=false;
    wwState.actionUsed=false;wwState.votesCast={};wwState.propagandaSent=false;
    wwCleanupIntervals();
}
function wwCleanupIntervals(){
    if(wwState.chatInterval)clearInterval(wwState.chatInterval);
    if(wwState.stateInterval)clearInterval(wwState.stateInterval);
    if(wwState.timerInterval)clearInterval(wwState.timerInterval);
    wwState.chatInterval=null;wwState.stateInterval=null;wwState.timerInterval=null;
}

/* ============================================================
   LOBBY UI
============================================================ */
function wwShowLobby(){
    document.getElementById('wwLobbyScreen').style.display='flex';
    document.getElementById('wwWaitingScreen').style.display='none';
    document.getElementById('wwGameScreen').style.display='none';
    document.getElementById('wwLobbyContent').innerHTML=`
        <div style="display:flex;flex-direction:column;gap:12px;width:300px">
            <button onclick="wwCreateRoom()" style="padding:16px;background:linear-gradient(135deg,#7B2D8B,#E8395A);color:#fff;border:none;border-radius:14px;cursor:pointer;font-weight:800;font-size:1rem;font-family:'Nunito',sans-serif">?? Buat Room Baru</button>
            <div style="display:flex;gap:8px">
                <input type="text" id="wwJoinCodeInput" placeholder="Kode Room (4 huruf)" maxlength="4"
                    style="flex:1;padding:14px;background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.2);border-radius:12px;color:#fff;font-family:'Nunito',sans-serif;font-size:1rem;text-transform:uppercase;text-align:center;letter-spacing:4px"
                    oninput="this.value=this.value.toUpperCase()">
                <button onclick="wwJoinRoom()" style="padding:14px 20px;background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.2);color:#fff;border-radius:12px;cursor:pointer;font-weight:800;font-family:'Nunito',sans-serif">Masuk</button>
            </div>
            <div style="color:rgba(255,255,255,.4);font-size:.8rem;text-align:center">Butuh 612 pemain untuk memulai</div>
        </div>`;
}

/* ============================================================
   ROOM MANAGEMENT  Supabase
============================================================ */
async function wwCreateRoom(){
    showLoading();
    try{
        const code = wwGenCode();
        const {data,error} = await db.from('ww_rooms').insert({
            code, host_nim: wwState.myNim, phase: WW_PHASE.NIGHT,
            round: 1, active: false, game_started: false,
            created_at: Date.now(), phase_end_time: null, dead_players: []
        }).select().single();
        if(error)throw error;
        wwState.roomId = data.id;
        wwState.roomCode = code;
        wwState.isHost = true;
        await wwJoinAsPlayer();
        wwShowWaiting();
    }catch(e){alert('? Gagal buat room: '+e.message+'\n\nPastikan tabel ww_rooms, ww_players, ww_messages, ww_actions sudah dibuat di Supabase.');}
    finally{hideLoading();}
}

async function wwJoinRoom(){
    const code = (document.getElementById('wwJoinCodeInput')?.value||'').toUpperCase().trim();
    if(!code||code.length!==4){alert('Masukkan kode room 4 huruf!');return;}
    showLoading();
    try{
        const {data:room} = await db.from('ww_rooms').select('*').eq('code',code).single();
        if(!room){alert('? Room tidak ditemukan!');return;}
        if(room.game_started){alert('? Permainan sudah dimulai!');return;}
        const {data:pls} = await db.from('ww_players').select('*').eq('room_id',room.id);
        if((pls||[]).length>=12){alert('? Room sudah penuh (maks 12 pemain)!');return;}
        wwState.roomId = room.id;
        wwState.roomCode = code;
        wwState.isHost = room.host_nim === wwState.myNim;
        await wwJoinAsPlayer();
        wwShowWaiting();
    }catch(e){alert('? Gagal join: '+e.message);}
    finally{hideLoading();}
}

async function wwJoinAsPlayer(){
    // Cek sudah ada belum
    const {data:existing} = await db.from('ww_players').select('id').eq('room_id',wwState.roomId).eq('nim',wwState.myNim).maybeSingle();
    if(!existing){
        await db.from('ww_players').insert({
            room_id: wwState.roomId, nim: wwState.myNim,
            name: wwState.myName, role: null, alive: true, score: 0, vote_target: null
        });
    }
}

async function wwLeaveRoom(){
    if(!wwState.roomId)return;
    wwCleanupIntervals();
    try{
        await db.from('ww_players').delete().eq('room_id',wwState.roomId).eq('nim',wwState.myNim);
        // Jika host dan game belum mulai, hapus room
        if(wwState.isHost){
            const {data:pls}=await db.from('ww_players').select('nim').eq('room_id',wwState.roomId);
            if(!pls||pls.length===0) await wwDeleteRoomData(wwState.roomId);
        }
    }catch(e){console.error(e);}
    wwResetState();
    wwShowLobby();
}

async function wwDeleteRoomData(roomId){
    await Promise.all([
        db.from('ww_players').delete().eq('room_id',roomId),
        db.from('ww_messages').delete().eq('room_id',roomId),
        db.from('ww_actions').delete().eq('room_id',roomId),
        db.from('ww_rooms').delete().eq('id',roomId)
    ]);
}

/* ============================================================
   WAITING ROOM
============================================================ */
function wwShowWaiting(){
    document.getElementById('wwLobbyScreen').style.display='none';
    document.getElementById('wwWaitingScreen').style.display='block';
    document.getElementById('wwGameScreen').style.display='none';
    document.getElementById('wwRoomCodeDisplay').innerText = wwState.roomCode;
    document.getElementById('wwStartBtn').style.display = wwState.isHost ? 'inline-block' : 'none';
    wwPollWaiting();
    wwState.stateInterval = setInterval(wwPollWaiting, 2000);
}
async function wwPollWaiting(){
    if(!wwState.roomId)return;
    try{
        const {data:room} = await db.from('ww_rooms').select('*').eq('id',wwState.roomId).single();
        if(!room)return;
        const {data:pls} = await db.from('ww_players').select('*').eq('room_id',wwState.roomId);
        const players = pls||[];
        // Render daftar pemain
        const listEl = document.getElementById('wwWaitingPlayers');
        listEl.innerHTML = players.map(p=>`<div class="ww-lobby-player ${p.nim===room.host_nim?'host':''}">${p.nim===room.host_nim?'?? ':''} ${p.name}</div>`).join('');
        const statusEl = document.getElementById('wwWaitingStatus');
        statusEl.innerHTML = `${players.length} pemain bergabung ${players.length>=6?'<span style="color:#4caf50">? Siap dimulai!</span>':'<span style="color:#ff8a65">(min 6)</span>'}`;
        // Jika game sudah dimulai oleh host, pindah ke game screen
        if(room.game_started){
            clearInterval(wwState.stateInterval);
            await wwEnterGame(room, players);
        }
    }catch(e){console.error('poll waiting err',e);}
}

async function wwHostStartGame(){
    const {data:pls} = await db.from('ww_players').select('*').eq('room_id',wwState.roomId);
    const players = pls||[];
    if(players.length<6){alert('Minimal 6 pemain untuk memulai!');return;}
    if(players.length>12){alert('Maksimal 12 pemain!');return;}
    showLoading();
    try{
        // Assign roles
        const roles = wwGenerateRoles(players.length);
        wwState.players = players;
        for(let i=0;i<players.length;i++){
            await db.from('ww_players').update({role:roles[i]}).eq('id',players[i].id);
        }
        // Set phase malam, phase_end_time 60 detik
        const phaseEnd = Date.now()+60000;
        await db.from('ww_rooms').update({
            game_started:true, active:true, phase:WW_PHASE.NIGHT,
            round:1, phase_end_time:phaseEnd, dead_players:[]
        }).eq('id',wwState.roomId);
        // Pesan sistem
        await wwPostSystemMessage('?? Permainan dimulai! Malam pertama telah tiba. Serigala, pilih korbanmu...');
    }catch(e){alert('? Gagal mulai: '+e.message);}
    finally{hideLoading();}
}

function wwGenerateRoles(n){
    // Komposisi sesuai jumlah pemain
    const wolves = n>=10?2:1;
    const specials = ['philosopher','poet','journalist','detective'];
    const roles = Array(wolves).fill('werewolf');
    // Tambah special roles (maks 4)
    const numSpecial = Math.min(4, n - wolves - 1);
    for(let i=0;i<numSpecial;i++) roles.push(specials[i]);
    // Sisanya warga
    while(roles.length<n) roles.push('villager');
    // Shuffle
    for(let i=roles.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [roles[i],roles[j]]=[roles[j],roles[i]];
    }
    return roles;
}

function wwGenCode(){
    const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    return Array(4).fill(0).map(()=>chars[Math.floor(Math.random()*chars.length)]).join('');
}

/* ============================================================
   ENTER GAME SCREEN
============================================================ */
async function wwEnterGame(room, players){
    clearInterval(wwState.stateInterval);
    // Ambil role sendiri
    const myPlayer = players.find(p=>p.nim===wwState.myNim);
    if(!myPlayer){alert('Data pemain tidak ditemukan!');return;}
    wwState.myRole = myPlayer.role;
    wwState.players = players;
    wwState.phase = room.phase;
    wwState.round = room.round||1;
    wwState.phaseEndTime = room.phase_end_time;
    wwState.gameActive = true;

    document.getElementById('wwLobbyScreen').style.display='none';
    document.getElementById('wwWaitingScreen').style.display='none';
    document.getElementById('wwGameScreen').style.display='block';

    wwRenderRoleCard();
    wwRenderPhase();
    // Start polling
    wwState.chatInterval = setInterval(wwPollChat, 2000);
    wwState.stateInterval = setInterval(wwPollGameState, 3000);
    wwStartTimer();
    await wwPollChat();
}

/* ============================================================
   GAME POLLING
============================================================ */
async function wwPollGameState(){
    if(!wwState.roomId||!wwState.gameActive)return;
    try{
        const {data:room} = await db.from('ww_rooms').select('*').eq('id',wwState.roomId).single();
        if(!room||!room.active)return;
        const {data:pls} = await db.from('ww_players').select('*').eq('room_id',wwState.roomId);
        wwState.players = pls||[];

        // Update fase jika berubah
        if(room.phase !== wwState.phase){
            wwState.phase = room.phase;
            wwState.round = room.round||1;
            wwState.phaseEndTime = room.phase_end_time;
            wwState.actionUsed = false;
            wwState.propagandaSent = false;
            wwRenderPhase();
            wwStartTimer();
        }
        wwRenderPlayerList();
        wwUpdateScoreDisplay();

        // Cek apakah game selesai
        if(room.game_over){
            wwState.gameActive = false;
            wwCleanupIntervals();
            wwShowResult(room);
        }
    }catch(e){console.error('poll state err',e);}
}

async function wwPollChat(){
    if(!wwState.roomId)return;
    try{
        const {data:msgs} = await db.from('ww_messages')
            .select('*').eq('room_id',wwState.roomId)
            .order('created_at',{ascending:true}).limit(200);
        const area = document.getElementById('wwChatArea');
        if(!area)return;
        const atBottom = area.scrollHeight-area.scrollTop-area.clientHeight < 60;
        area.innerHTML='';
        (msgs||[]).forEach(m=>area.appendChild(wwBuildMsgEl(m)));
        if(atBottom) area.scrollTop=area.scrollHeight;
    }catch(e){console.error('poll chat err',e);}
}

function wwBuildMsgEl(m){
    const div=document.createElement('div');
    let cls='other',senderLabel='';
    if(m.type==='system') cls='system';
    else if(m.type==='clue') cls='clue';
    else if(m.type==='dead') cls='dead-announce';
    else if(m.type==='propaganda') cls='propaganda';
    else if(m.sender_nim===wwState.myNim) cls='own';

    if(m.type==='propaganda') senderLabel='<div class="msg-sender">?? Pesan Anonim</div>';
    else if(m.type!=='system'&&m.type!=='clue'&&m.type!=='dead') senderLabel=`<div class="msg-sender">${m.sender_name||'?'}</div>`;

    div.className=`ww-msg ${cls}`;
    div.innerHTML=`${senderLabel}<div>${m.content}</div><div class="msg-time">${new Date(m.created_at).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'})}</div>`;

    // Keyword scoring  hanya untuk pesan pemain biasa
    if(m.type==='chat'&&m.sender_nim===wwState.myNim){
        const lc=m.content.toLowerCase();
        const hit=WW_TRIGGER_KEYWORDS.filter(kw=>lc.includes(kw)).length;
        if(hit>0&&!m.scored){
            wwAddScore(2,'Argumen analitis (+2 poin)');
            // Mark scored agar tidak double
            db.from('ww_messages').update({scored:true}).eq('id',m.id).then(()=>{});
        }
    }
    return div;
}

/* ============================================================
   PHASE RENDER
============================================================ */
function wwRenderPhase(){
    const badge = document.getElementById('wwPhaseBadge');
    const round = document.getElementById('wwRoundBadge');
    const phaseLabels = {
        night: {label:'?? Malam', cls:'phase-night'},
        morning: {label:'?? Pagi', cls:'phase-morning'},
        day: {label:'?? Siang - Diskusi', cls:'phase-day'},
        vote: {label:'??? Voting', cls:'phase-vote'}
    };
    const p = phaseLabels[wwState.phase]||phaseLabels.night;
    badge.innerText = p.label;
    badge.className = `ww-phase-badge ${p.cls} ww-phase-active`;
    round.innerText = `Ronde ${wwState.round}`;
    wwRenderActionPanel();
}

function wwRenderRoleCard(){
    const role = WW_ROLES[wwState.myRole]||{name:'?',desc:'?'};
    document.getElementById('wwMyRoleName').innerText = role.name;
    document.getElementById('wwMyRoleDesc').innerText = role.desc;
}

function wwRenderPlayerList(){
    const el = document.getElementById('wwPlayerList');if(!el)return;
    el.innerHTML='';
    wwState.players.forEach(p=>{
        const isSelf = p.nim===wwState.myNim;
        const div=document.createElement('div');
        div.className=`ww-player-item ${p.alive?'alive':'dead'} ${isSelf?'self':''}`;
        div.innerHTML=`${isSelf?'?? ':''}${p.name}${isSelf?' (Anda)':''} ${!p.alive?'??':''}`;
        el.appendChild(div);
    });
}

function wwUpdateScoreDisplay(){
    const me = wwState.players.find(p=>p.nim===wwState.myNim);
    if(me) wwState.myScore = me.score||0;
    const el=document.getElementById('wwMyScore');
    if(el) el.innerHTML=`<span style="color:#ffd54f;font-weight:700">${wwState.myScore}</span> poin terkumpul`;
}

/* ============================================================
   ACTION PANEL  berdasarkan fase & peran
============================================================ */
function wwRenderActionPanel(){
    const panel = document.getElementById('wwActionPanel');
    if(!panel)return;
    panel.style.display='none';
    panel.innerHTML='';
    const myAlive = wwState.players.find(p=>p.nim===wwState.myNim);
    if(!myAlive||!myAlive.alive) return;

    const phase = wwState.phase;
    const role = wwState.myRole;

    if(phase===WW_PHASE.NIGHT && role==='werewolf'){
        panel.style.display='block';
        const alivePlayers = wwState.players.filter(p=>p.alive&&p.nim!==wwState.myNim);
        panel.innerHTML=`<div style="color:rgba(255,255,255,.6);font-size:.8rem;margin-bottom:8px">?? Pilih korban malam ini:</div>
            <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px">
                ${alivePlayers.map(p=>`<button class="ww-action-btn night-action" onclick="wwSelectNightTarget('${p.nim}','${p.name}')">${p.name}</button>`).join('')}
            </div>
            <div id="wwNightSelected" style="color:#ef9a9a;font-size:.85rem;margin-bottom:8px"></div>
            <div style="color:rgba(255,255,255,.5);font-size:.75rem;margin-bottom:6px">?? Kirim propaganda anonim:</div>
            <input type="text" id="wwPropInput" class="ww-prop-input" placeholder="Ketik pesan propaganda (maks 100 karakter)..." maxlength="100">
            <button onclick="wwSendPropaganda()" class="ww-action-btn prop-action" style="margin-top:6px">?? Kirim Propaganda</button>`;
    }
    else if(phase===WW_PHASE.MORNING){
        if(['philosopher','poet','journalist','detective'].includes(role)&&!wwState.actionUsed){
            panel.style.display='block';
            const alivePlayers = wwState.players.filter(p=>p.alive&&p.nim!==wwState.myNim);
            let btnHtml='';
            if(role==='philosopher') btnHtml=`<button class="ww-action-btn day-action" onclick="wwUseSkill('philosopher')">?? Aktifkan Klue Filsafat</button>`;
            else if(role==='poet') btnHtml=`<button class="ww-action-btn day-action" onclick="wwUseSkill('poet')">?? Aktifkan Klue Puisi</button>`;
            else if(role==='journalist') btnHtml=`
                <div style="color:rgba(255,255,255,.6);font-size:.8rem;margin-bottom:6px">?? Pilih pemain untuk diwawancarai:</div>
                <div style="display:flex;flex-wrap:wrap;gap:6px">
                    ${alivePlayers.map(p=>`<button class="ww-action-btn day-action" onclick="wwUseSkillTarget('journalist','${p.nim}','${p.name}')">${p.name}</button>`).join('')}
                </div>`;
            else if(role==='detective') btnHtml=`
                <div style="color:rgba(255,255,255,.6);font-size:.8rem;margin-bottom:6px">?? Selidiki pemain:</div>
                <div style="display:flex;flex-wrap:wrap;gap:6px">
                    ${alivePlayers.map(p=>`<button class="ww-action-btn day-action" onclick="wwUseSkillTarget('detective','${p.nim}','${p.name}')">${p.name}</button>`).join('')}
                </div>`;
            panel.innerHTML=`<div style="color:rgba(255,255,255,.6);font-size:.8rem;margin-bottom:8px">?? Aktifkan kekuatanmu pagi ini:</div>${btnHtml}`;
        }
    }
    else if(phase===WW_PHASE.VOTE){
        panel.style.display='block';
        const alivePlayers = wwState.players.filter(p=>p.alive&&p.nim!==wwState.myNim);
        panel.innerHTML=`<div style="color:rgba(255,255,255,.7);font-weight:700;font-size:.85rem;margin-bottom:8px">??? Vote siapa yang dicurigai sebagai serigala?</div>
            <div style="display:flex;flex-wrap:wrap;gap:6px">
                ${alivePlayers.map(p=>`<button class="ww-action-btn vote-action" onclick="wwCastVote('${p.nim}','${p.name}')">${p.name}</button>`).join('')}
            </div>
            <div id="wwVoteStatus" style="color:#ef9a9a;font-size:.8rem;margin-top:8px"></div>`;
    }
}

/* ============================================================
   ACTIONS
============================================================ */
async function wwSelectNightTarget(nim,name){
    wwState.nightTarget=nim;
    document.getElementById('wwNightSelected').innerHTML=`?? Target dipilih: <strong>${name}</strong>  Menunggu akhir malam...`;
    // Simpan aksi ke DB
    await db.from('ww_actions').upsert({
        room_id:wwState.roomId, actor_nim:wwState.myNim,
        action_type:'night_kill', target_nim:nim, round:wwState.round
    },{onConflict:'room_id,actor_nim,round,action_type'});
    await wwPostSystemMessage(`?? Serigala telah memilih korban... (sistem akan mengumumkan pagi hari)`, 'system', true);
}

async function wwUseSkill(role){
    if(wwState.actionUsed)return;
    wwState.actionUsed=true;
    let clue='';
    if(role==='philosopher') clue=WW_CLUES_PHILOSOPHER[Math.floor(Math.random()*WW_CLUES_PHILOSOPHER.length)];
    else if(role==='poet') clue=WW_CLUES_POET[Math.floor(Math.random()*WW_CLUES_POET.length)];
    const roleNames={philosopher:'?? Filsafat',poet:'?? Bujangga Puisi'};
    await wwPostClue(`[${roleNames[role]}]\n\n"${clue}"`);
    await wwAddScoreDB(3,'Klue berhasil diaktifkan (+3 poin)');
    wwState.actionUsed=true;
    wwRenderActionPanel();
}

async function wwUseSkillTarget(role, targetNim, targetName){
    if(wwState.actionUsed)return;
    wwState.actionUsed=true;
    const targetPlayer = wwState.players.find(p=>p.nim===targetNim);
    const isWolf = targetPlayer?.role==='werewolf';
    let clue='';
    if(role==='journalist'){
        clue=isWolf ? WW_CLUES_JOURNALIST[Math.floor(Math.random()*WW_CLUES_JOURNALIST.length)] : `"Aku hanya mengamati, bukan berburu. Kepentinganku adalah kebenaran."`;
        await wwPostClue(`[?? Penulis Koran  Wawancara dengan ${targetName}]\n\n${clue}`);
    } else if(role==='detective'){
        clue=isWolf ? WW_CLUES_DETECTIVE[Math.floor(Math.random()*WW_CLUES_DETECTIVE.length)] : `"Tidak mencurigakan. Pola perilaku normal."`;
        await wwPostClue(`[?? Detektif  Penyelidikan terhadap ${targetName}]\n\nHasil analisis: ${clue}`);
    }
    await wwAddScoreDB(3,'Skill investigasi digunakan (+3 poin)');
    wwRenderActionPanel();
}

async function wwSendPropaganda(){
    if(wwState.propagandaSent){alert('Sudah mengirim propaganda ronde ini!');return;}
    const input=document.getElementById('wwPropInput');
    const text=(input?.value||'').trim();
    if(!text){alert('Tulis pesan propaganda dulu!');return;}
    wwState.propagandaSent=true;
    await db.from('ww_messages').insert({
        room_id:wwState.roomId, sender_nim:'anon', sender_name:'Anonim',
        content:text, type:'propaganda', created_at:Date.now(), scored:false
    });
    if(input)input.value='';
}

async function wwCastVote(targetNim, targetName){
    wwState.votesCast[wwState.myNim]=targetNim;
    document.getElementById('wwVoteStatus').innerHTML=`? Votemu: <strong>${targetName}</strong>`;
    await db.from('ww_players').update({vote_target:targetNim}).eq('room_id',wwState.roomId).eq('nim',wwState.myNim);
    // Kalau ini host, cek apakah semua sudah vote
    if(wwState.isHost) await wwCheckVoteComplete();
}

async function wwCheckVoteComplete(){
    const {data:pls}=await db.from('ww_players').select('*').eq('room_id',wwState.roomId).eq('alive',true);
    const alive=pls||[];
    const voted=alive.filter(p=>p.vote_target);
    if(voted.length>=alive.length) await wwProcessVotes(alive);
}

async function wwProcessVotes(alivePlayers){
    // Hitung vote
    const counts={};
    alivePlayers.forEach(p=>{if(p.vote_target)counts[p.vote_target]=(counts[p.vote_target]||0)+1;});
    const maxVotes=Math.max(...Object.values(counts));
    const condemned=Object.keys(counts).find(k=>counts[k]===maxVotes);
    if(!condemned){await wwPostSystemMessage('?? Tidak ada kesepakatan. Tidak ada yang dieliminasi ronde ini.');await wwAdvancePhase('next_night');return;}
    const condPlayer=alivePlayers.find(p=>p.nim===condemned);
    const isWolf=condPlayer?.role==='werewolf';
    await db.from('ww_players').update({alive:false}).eq('room_id',wwState.roomId).eq('nim',condemned);
    await wwPostSystemMessage(`??? Hasil voting: **${condPlayer?.name||'?'}** dieliminasi dengan ${maxVotes} suara!\nPerannya adalah: ${WW_ROLES[condPlayer?.role]?.name||'?'}`, 'dead');
    if(isWolf){
        // Berikan skor kepada yang vote ke serigala
        const correctVoters=alivePlayers.filter(p=>p.vote_target===condemned&&p.nim!==condemned);
        for(const v of correctVoters){
            await db.from('ww_players').update({score:(v.score||0)+5}).eq('room_id',wwState.roomId).eq('nim',v.nim);
        }
        await wwPostSystemMessage(`?? Kalian berhasil menemukan serigala! (+5 poin untuk yang memilih benar)`);
    }
    // Reset vote_target
    await db.from('ww_players').update({vote_target:null}).eq('room_id',wwState.roomId);
    await wwCheckGameOver();
}

async function wwCheckGameOver(){
    const {data:pls}=await db.from('ww_players').select('*').eq('room_id',wwState.roomId);
    const alive=pls.filter(p=>p.alive);
    const wolves=alive.filter(p=>p.role==='werewolf');
    const villagers=alive.filter(p=>p.role!=='werewolf');
    if(wolves.length===0){
        await db.from('ww_rooms').update({game_over:true,winner:'villagers',active:false}).eq('id',wwState.roomId);
        await wwPostSystemMessage('?? WARGA DESA MENANG! Semua serigala telah ditemukan!','system');
    } else if(wolves.length>=villagers.length){
        await db.from('ww_rooms').update({game_over:true,winner:'werewolves',active:false}).eq('id',wwState.roomId);
        await wwPostSystemMessage('?? SERIGALA MENANG! Mereka berhasil menguasai desa!','system');
    } else {
        await wwAdvancePhase('next_night');
    }
}

async function wwAdvancePhase(next){
    const phaseEnd = Date.now() + (next==='morning'?45000:next==='day'?300000:next==='vote'?90000:60000);
    const phaseMap={'next_night':WW_PHASE.NIGHT,'morning':WW_PHASE.MORNING,'day':WW_PHASE.DAY,'vote':WW_PHASE.VOTE};
    const newPhase=phaseMap[next]||WW_PHASE.NIGHT;
    const newRound=next==='next_night'?(wwState.round+1):wwState.round;
    await db.from('ww_rooms').update({phase:newPhase,round:newRound,phase_end_time:phaseEnd}).eq('id',wwState.roomId);
    const phaseMsg={'next_night':'?? Malam tiba. Serigala memilih korban berikutnya...','morning':'?? Pagi tiba! Gunakan kekuatan spesialmu.','day':'?? Siang hari! Diskusikan klue yang ada dan ungkap siapa serigalanya.','vote':'??? Waktunya voting! Siapa yang kalian curigai sebagai serigala?'};
    await wwPostSystemMessage(phaseMsg[next]||'Fase baru dimulai.');
}

/* Dipanggil oleh host timer saat fase habis */
async function wwOnPhaseTimeout(){
    if(!wwState.isHost||!wwState.gameActive)return;
    try{
        const {data:room}=await db.from('ww_rooms').select('*').eq('id',wwState.roomId).single();
        if(!room||!room.active||room.game_over)return;
        if(room.phase===WW_PHASE.NIGHT){
            // Proses kill
            const {data:actions}=await db.from('ww_actions').select('*').eq('room_id',wwState.roomId).eq('round',wwState.round).eq('action_type','night_kill');
            if(actions&&actions.length>0){
                const kill=actions[0];
                const {data:victim}=await db.from('ww_players').select('*').eq('room_id',wwState.roomId).eq('nim',kill.target_nim).single();
                if(victim&&victim.alive){
                    await db.from('ww_players').update({alive:false}).eq('room_id',wwState.roomId).eq('nim',kill.target_nim);
                    const lastWords=["Maaf, aku tidak bisa menyelesaikan tugasku...","Percayalah pada kalimat terakhirku: kebenaran selalu menang.","Aku pergi, tapi jejakku tetap ada dalam kata-kata.","Jangan biarkan kegelapan memenangkan percakapan.","Cari yang paling diammerekalah yang paling berbahaya."];
                    await wwPostSystemMessage(`?? Pagi tiba... ${victim.name} ditemukan tidak sadarkan diri.\n\n"${lastWords[Math.floor(Math.random()*lastWords.length)]}"  ${victim.name}`,'dead');
                    await wwCheckGameOver();
                    return;
                }
            }
            await wwAdvancePhase('morning');
        } else if(room.phase===WW_PHASE.MORNING){
            await wwAdvancePhase('day');
        } else if(room.phase===WW_PHASE.DAY){
            await wwAdvancePhase('vote');
        } else if(room.phase===WW_PHASE.VOTE){
            // Proses vote yang sudah ada
            const {data:pls}=await db.from('ww_players').select('*').eq('room_id',wwState.roomId).eq('alive',true);
            await wwProcessVotes(pls||[]);
        }
    }catch(e){console.error('phase timeout err',e);}
}

/* ============================================================
   TIMER
============================================================ */
function wwStartTimer(){
    if(wwState.timerInterval) clearInterval(wwState.timerInterval);
    wwState.timerInterval = setInterval(async ()=>{
        const el=document.getElementById('wwTimerDisplay');
        if(!el||!wwState.phaseEndTime)return;
        const remaining = Math.max(0, wwState.phaseEndTime - Date.now());
        const m=Math.floor(remaining/60000),s=Math.floor((remaining%60000)/1000);
        el.innerText=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        if(remaining<=0&&wwState.isHost) await wwOnPhaseTimeout();
    },1000);
}

/* ============================================================
   CHAT
============================================================ */
async function wwSendChat(){
    if(!wwState.gameActive)return;
    const input=document.getElementById('wwChatInput');
    const text=(input?.value||'').trim();
    if(!text)return;
    // Cek apakah pemain masih hidup
    const me=wwState.players.find(p=>p.nim===wwState.myNim);
    if(!me?.alive){alert('Pemain yang sudah mati tidak bisa chat!');return;}
    // Hanya bisa chat saat siang
    if(wwState.phase===WW_PHASE.NIGHT&&wwState.myRole!=='werewolf'){
        alert('Pemain non-serigala tidak bisa bicara di malam hari!');return;
    }
    await db.from('ww_messages').insert({
        room_id:wwState.roomId, sender_nim:wwState.myNim, sender_name:wwState.myName,
        content:text, type:'chat', created_at:Date.now(), scored:false
    });
    if(input) input.value='';
}

async function wwPostSystemMessage(content, type='system', skipRefresh=false){
    await db.from('ww_messages').insert({
        room_id:wwState.roomId, sender_nim:'system', sender_name:'Sistem',
        content, type, created_at:Date.now(), scored:false
    });
    if(!skipRefresh) await wwPollChat();
}
async function wwPostClue(content){
    await db.from('ww_messages').insert({
        room_id:wwState.roomId, sender_nim:'system', sender_name:'Sistem',
        content, type:'clue', created_at:Date.now(), scored:false
    });
    await wwPollChat();
}

/* ============================================================
   SCORING
============================================================ */
async function wwAddScore(pts, reason){
    const me=wwState.players.find(p=>p.nim===wwState.myNim);if(!me)return;
    const newScore=(me.score||0)+pts;
    await db.from('ww_players').update({score:newScore}).eq('room_id',wwState.roomId).eq('nim',wwState.myNim);
    wwState.myScore=newScore;
    wwUpdateScoreDisplay();
}
async function wwAddScoreDB(pts, reason){
    await wwAddScore(pts, reason);
}

/* ============================================================
   RESULT & SAVE POINTS
============================================================ */
async function wwShowResult(room){
    const {data:pls}=await db.from('ww_players').select('*').eq('room_id',wwState.roomId);
    const players=pls||[];
    const me=players.find(p=>p.nim===wwState.myNim);
    const myTeam=WW_ROLES[wwState.myRole]?.team||'good';
    const winner=room.winner||'';
    const iWin=(winner==='villagers'&&myTeam==='good')||(winner==='werewolves'&&myTeam==='evil');

    document.getElementById('wwResultTitle').innerHTML=iWin?`<span class="ww-result-win">?? Kamu Menang!</span>`:`<span class="ww-result-lose">?? Kamu Kalah</span>`;
    document.getElementById('wwResultBody').innerHTML=`
        ${winner==='villagers'?'??? Warga Desa berhasil mengungkap semua serigala!':'?? Serigala berhasil menguasai desa!'}<br><br>
        Peranmu: <strong>${WW_ROLES[wwState.myRole]?.name||'?'}</strong><br>
        Poin terkumpul: <strong style="color:#ffd54f">${me?.score||0} poin</strong>`;

    // Leaderboard akhir
    const sorted=[...players].sort((a,b)=>(b.score||0)-(a.score||0));
    document.getElementById('wwFinalScores').innerHTML=`
        <div style="font-weight:700;margin-bottom:12px;color:#fff">?? Skor Akhir</div>
        ${sorted.map((p,i)=>`<div style="display:flex;justify-content:space-between;padding:8px 12px;background:rgba(255,255,255,.06);border-radius:8px;margin-bottom:6px;color:#e0e0e0">
            <span>${i===0?'??':i===1?'??':i===2?'??':'  '} ${p.name} ${p.nim===wwState.myNim?'(Anda)':''}</span>
            <span style="color:#ffd54f;font-weight:700">${p.score||0} poin</span>
        </div>`).join('')}`;

    document.getElementById('wwResultOverlay').style.display='flex';
}

async function wwEndAndSavePoints(){
    showLoading();
    try{
        const {data:pls}=await db.from('ww_players').select('*').eq('room_id',wwState.roomId);
        const me=(pls||[]).find(p=>p.nim===wwState.myNim);
        const pts=me?.score||0;

        if(pts>0&&currentUser&&!currentUser.isAdmin){
            // Tambah ke point_logs user
            const dbUser=allUsers.find(u=>u.nim===wwState.myNim);
            if(dbUser){
                const newAch=[...(dbUser.achievements||[]),{type:'karya',description:`Game Wharewolf  ${pts} poin`,points:pts,timestamp:Date.now()}];
                const newLog=[...(dbUser.point_logs||[]),{type:'karya',description:'Game Wharewolf',points:pts,timestamp:Date.now()}];
                await db.from('users').update({points:dbUser.points+pts,achievements:newAch,point_logs:newLog}).eq('nim',wwState.myNim);
                dbUser.points+=pts;dbUser.achievements=newAch;dbUser.point_logs=newLog;
                if(currentUser.nim===wwState.myNim){currentUser.points+=pts;currentUser.achievements=newAch;}
                // Update team juga
                if(dbUser.teams?.length){
                    const teamName=dbUser.teams[0];
                    const team=allTeams.find(t=>t.name===teamName);
                    if(team){
                        const newActs=[...(team.activities||[]),`Game Wharewolf: ${dbUser.name} (+${pts} poin) [${new Date().toLocaleDateString('id-ID')}]`];
                        await db.from('teams').update({points:team.points+pts,activities:newActs}).eq('name',teamName);
                        team.points+=pts;
                    }
                }
                alert(`? ${pts} poin berhasil disimpan ke profilmu!`);
                renderTables();initChart();
            }
        }
        // Hapus data game dari Supabase (bersihkan DB)
        if(wwState.isHost) await wwDeleteRoomData(wwState.roomId);
        else await db.from('ww_players').delete().eq('room_id',wwState.roomId).eq('nim',wwState.myNim);
    }catch(e){console.error('save points err',e);}
    finally{hideLoading();}
    wwCleanupIntervals();
    wwResetState();
    document.getElementById('wwOverlay').style.display='none';
    document.getElementById('wwResultOverlay').style.display='none';
}

window.onload=init;
    </script>
</body>

</html>

